<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/Blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/Blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/Blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/Blog/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="googlea0cb77247135ae4c.html">

<link rel="stylesheet" href="/Blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha256-xejo6yLi6vGtAjcMIsY8BHdKsLg7QynVlFMzdQgUuy8=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"cromarmot.github.io","root":"/Blog/","images":"/Blog/images","scheme":"Muse","darkmode":false,"version":"8.12.3","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜尋...","empty":"我們無法找到任何有關 ${query} 的搜索結果","hits_time":"${hits} 找到 ${time} 個結果","hits":"找到 ${hits} 個結果"},"path":"/Blog/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/Blog/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Cro-Marmot&#39;s Blog">
<meta property="og:url" content="https://cromarmot.github.io/Blog/page/7/index.html">
<meta property="og:site_name" content="Cro-Marmot&#39;s Blog">
<meta property="og:locale" content="zh_TW">
<meta property="article:author" content="Cro-Marmot">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://cromarmot.github.io/Blog/page/7/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-TW","comments":"","permalink":"","path":"page/7/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Cro-Marmot's Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/Blog/css/noscript.css">
  </noscript>
<link rel="alternate" href="/Blog/atom.xml" title="Cro-Marmot's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/Blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Cro-Marmot's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/Blog/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a></li><li class="menu-item menu-item-archives"><a href="/Blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歸檔<span class="badge">124</span></a></li><li class="menu-item menu-item-yearmonth"><a href="/Blog/yearmonth/" rel="section"><i class="fa fa-calendar-days fa-fw"></i>年月</a></li><li class="menu-item menu-item-categories"><a href="/Blog/categories/" rel="section"><i class="fa fa-shapes fa-fw"></i>分類<span class="badge">32</span></a></li><li class="menu-item menu-item-tags"><a href="/Blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>標籤<span class="badge">143</span></a></li><li class="menu-item menu-item-rss"><a href="/Blog/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>rss</a></li><li class="menu-item menu-item-about"><a href="/Blog/20-07-13-rsa/#contact" rel="section"><i class="fa fa-user fa-fw"></i>關於</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Cro-Marmot"
      src="https://avatars.githubusercontent.com/u/24691835?v=4">
  <p class="site-author-name" itemprop="name">Cro-Marmot</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/Blog/archives/">
          <span class="site-state-item-count">124</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/Blog/categories/">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/Blog/tags/">
        <span class="site-state-item-count">143</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/cromarmot" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cromarmot" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yexiaorain@gmail.com" title="E-Mail → mailto:yexiaorain@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll site-overview-item animated">
    <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://atcoder.jp/users/cromarmot" title="https:&#x2F;&#x2F;atcoder.jp&#x2F;users&#x2F;cromarmot" rel="noopener" target="_blank">AtCoder</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://codeforces.com/profile/Cro-Marmot" title="https:&#x2F;&#x2F;codeforces.com&#x2F;profile&#x2F;Cro-Marmot" rel="noopener" target="_blank">Codeforces</a>
        </li>
    </ul>
  </div>

        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="回到頂端">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://cromarmot.github.io/Blog/19-10-21-throttle-debounce/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/24691835?v=4">
      <meta itemprop="name" content="Cro-Marmot">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Blog/19-10-21-throttle-debounce/" class="post-title-link" itemprop="url">throttle vs debounce</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-10-21 15:09:01" itemprop="dateCreated datePublished" datetime="2019-10-21T15:09:01+08:00">2019-10-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2023-02-16 03:52:07" itemprop="dateModified" datetime="2023-02-16T03:52:07+08:00">2023-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/Blog/19-10-21-throttle-debounce/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="19-10-21-throttle-debounce/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>4.6k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>4 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="What"><a href="#What" class="headerlink" title="What"></a>What</h1><p>基本讲就是 throttle(截流)和debounce(去抖)</p>
<p>功能都是为了避免快速反复触发</p>
<p>比如 用户快速点击按钮</p>
<p>假设设置为1s</p>
<p>throttle相当于，执行的最小间隔为1s</p>
<p>debounce也是执行最小间隔为1s，但是假设用户持续的一直快速点击，函数不会执行，需要等到最后一次点击后过1s才执行</p>
<h1 id="直接看lodash的"><a href="#直接看lodash的" class="headerlink" title="直接看lodash的"></a>直接看lodash的</h1><p>throttle:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">throttle</span>(<span class="params">func, wait, options</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> leading = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">let</span> trailing = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> func !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;Expected a function&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isObject</span>(options)) &#123;</span><br><span class="line">    leading = <span class="string">&#x27;leading&#x27;</span> <span class="keyword">in</span> options ? !!options.<span class="property">leading</span> : leading</span><br><span class="line">    trailing = <span class="string">&#x27;trailing&#x27;</span> <span class="keyword">in</span> options ? !!options.<span class="property">trailing</span> : trailing</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">debounce</span>(func, wait, &#123;</span><br><span class="line">    leading,</span><br><span class="line">    trailing,</span><br><span class="line">    <span class="string">&#x27;maxWait&#x27;</span>: wait</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> throttle</span><br></pre></td></tr></table></figure>

<p>debounce:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">func, wait, options</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> lastArgs,</span><br><span class="line">    lastThis,</span><br><span class="line">    maxWait,</span><br><span class="line">    result,</span><br><span class="line">    timerId,</span><br><span class="line">    lastCallTime</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> lastInvokeTime = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> leading = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> maxing = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> trailing = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Bypass `requestAnimationFrame` by explicitly setting `wait=0`.</span></span><br><span class="line">  <span class="keyword">const</span> useRAF = (!wait &amp;&amp; wait !== <span class="number">0</span> &amp;&amp; <span class="keyword">typeof</span> root.<span class="property">requestAnimationFrame</span> === <span class="string">&#x27;function&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> func !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;Expected a function&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  wait = +wait || <span class="number">0</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isObject</span>(options)) &#123;</span><br><span class="line">    leading = !!options.<span class="property">leading</span></span><br><span class="line">    maxing = <span class="string">&#x27;maxWait&#x27;</span> <span class="keyword">in</span> options</span><br><span class="line">    maxWait = maxing ? <span class="title class_">Math</span>.<span class="title function_">max</span>(+options.<span class="property">maxWait</span> || <span class="number">0</span>, wait) : maxWait</span><br><span class="line">    trailing = <span class="string">&#x27;trailing&#x27;</span> <span class="keyword">in</span> options ? !!options.<span class="property">trailing</span> : trailing</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">invokeFunc</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> args = lastArgs</span><br><span class="line">    <span class="keyword">const</span> thisArg = lastThis</span><br><span class="line"></span><br><span class="line">    lastArgs = lastThis = <span class="literal">undefined</span></span><br><span class="line">    lastInvokeTime = time</span><br><span class="line">    result = func.<span class="title function_">apply</span>(thisArg, args)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">startTimer</span>(<span class="params">pendingFunc, wait</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (useRAF) &#123;</span><br><span class="line">      root.<span class="title function_">cancelAnimationFrame</span>(timerId)</span><br><span class="line">      <span class="keyword">return</span> root.<span class="title function_">requestAnimationFrame</span>(pendingFunc)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">setTimeout</span>(pendingFunc, wait)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">cancelTimer</span>(<span class="params">id</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (useRAF) &#123;</span><br><span class="line">      <span class="keyword">return</span> root.<span class="title function_">cancelAnimationFrame</span>(id)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">clearTimeout</span>(id)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">leadingEdge</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="comment">// Reset any `maxWait` timer.</span></span><br><span class="line">    lastInvokeTime = time</span><br><span class="line">    <span class="comment">// Start the timer for the trailing edge.</span></span><br><span class="line">    timerId = <span class="title function_">startTimer</span>(timerExpired, wait)</span><br><span class="line">    <span class="comment">// Invoke the leading edge.</span></span><br><span class="line">    <span class="keyword">return</span> leading ? <span class="title function_">invokeFunc</span>(time) : result</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">remainingWait</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> timeSinceLastCall = time - lastCallTime</span><br><span class="line">    <span class="keyword">const</span> timeSinceLastInvoke = time - lastInvokeTime</span><br><span class="line">    <span class="keyword">const</span> timeWaiting = wait - timeSinceLastCall</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> maxing</span><br><span class="line">      ? <span class="title class_">Math</span>.<span class="title function_">min</span>(timeWaiting, maxWait - timeSinceLastInvoke)</span><br><span class="line">      : timeWaiting</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">shouldInvoke</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> timeSinceLastCall = time - lastCallTime</span><br><span class="line">    <span class="keyword">const</span> timeSinceLastInvoke = time - lastInvokeTime</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Either this is the first call, activity has stopped and we&#x27;re at the</span></span><br><span class="line">    <span class="comment">// trailing edge, the system time has gone backwards and we&#x27;re treating</span></span><br><span class="line">    <span class="comment">// it as the trailing edge, or we&#x27;ve hit the `maxWait` limit.</span></span><br><span class="line">    <span class="keyword">return</span> (lastCallTime === <span class="literal">undefined</span> || (timeSinceLastCall &gt;= wait) ||</span><br><span class="line">      (timeSinceLastCall &lt; <span class="number">0</span>) || (maxing &amp;&amp; timeSinceLastInvoke &gt;= maxWait))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">timerExpired</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> time = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">shouldInvoke</span>(time)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">trailingEdge</span>(time)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Restart the timer.</span></span><br><span class="line">    timerId = <span class="title function_">startTimer</span>(timerExpired, <span class="title function_">remainingWait</span>(time))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">trailingEdge</span>(<span class="params">time</span>) &#123;</span><br><span class="line">    timerId = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only invoke if we have `lastArgs` which means `func` has been</span></span><br><span class="line">    <span class="comment">// debounced at least once.</span></span><br><span class="line">    <span class="keyword">if</span> (trailing &amp;&amp; lastArgs) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">invokeFunc</span>(time)</span><br><span class="line">    &#125;</span><br><span class="line">    lastArgs = lastThis = <span class="literal">undefined</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">cancel</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (timerId !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="title function_">cancelTimer</span>(timerId)</span><br><span class="line">    &#125;</span><br><span class="line">    lastInvokeTime = <span class="number">0</span></span><br><span class="line">    lastArgs = lastCallTime = lastThis = timerId = <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">flush</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> timerId === <span class="literal">undefined</span> ? result : <span class="title function_">trailingEdge</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">pending</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> timerId !== <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">debounced</span>(<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> time = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">    <span class="keyword">const</span> isInvoking = <span class="title function_">shouldInvoke</span>(time)</span><br><span class="line"></span><br><span class="line">    lastArgs = args</span><br><span class="line">    lastThis = <span class="variable language_">this</span></span><br><span class="line">    lastCallTime = time</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isInvoking) &#123;</span><br><span class="line">      <span class="keyword">if</span> (timerId === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">leadingEdge</span>(lastCallTime)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (maxing) &#123;</span><br><span class="line">        <span class="comment">// Handle invocations in a tight loop.</span></span><br><span class="line">        timerId = <span class="title function_">startTimer</span>(timerExpired, wait)</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">invokeFunc</span>(lastCallTime)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (timerId === <span class="literal">undefined</span>) &#123;</span><br><span class="line">      timerId = <span class="title function_">startTimer</span>(timerExpired, wait)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">  debounced.<span class="property">cancel</span> = cancel</span><br><span class="line">  debounced.<span class="property">flush</span> = flush</span><br><span class="line">  debounced.<span class="property">pending</span> = pending</span><br><span class="line">  <span class="keyword">return</span> debounced</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> debounce</span><br></pre></td></tr></table></figure>

<p>直接的参数区别</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">throttle</span><br><span class="line"></span><br><span class="line">  let leading = true</span><br><span class="line">  let maxing = true &amp;&amp; maxWait</span><br><span class="line">  let trailing = true</span><br><span class="line"></span><br><span class="line">debounce</span><br><span class="line">  let leading = false</span><br><span class="line">  let maxing = false</span><br><span class="line">  let trailing = true</span><br></pre></td></tr></table></figure>

<h1 id="Vue-有一个官方教程中的使用方法如下"><a href="#Vue-有一个官方教程中的使用方法如下" class="headerlink" title="Vue 有一个官方教程中的使用方法如下"></a>Vue 有一个官方教程中的使用方法如下</h1><p><a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/computed.html#%E4%BE%A6%E5%90%AC%E5%99%A8">https://cn.vuejs.org/v2/guide/computed.html#%E4%BE%A6%E5%90%AC%E5%99%A8</a></p>
<p>之前我也写过一个 在methods中 计算出一个函数，但是那样的返回和计算不能使用箭头函数，因为运行函数和执行的this不同，ide也报错，XD 虽然可用</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://github.com/lodash/lodash/blob/master/throttle.js">https://github.com/lodash/lodash/blob/master/throttle.js</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/lodash/lodash/blob/master/debounce.js">https://github.com/lodash/lodash/blob/master/debounce.js</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://cromarmot.github.io/Blog/19-10-18-adb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/24691835?v=4">
      <meta itemprop="name" content="Cro-Marmot">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Blog/19-10-18-adb/" class="post-title-link" itemprop="url">adb</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-10-18 15:09:01" itemprop="dateCreated datePublished" datetime="2019-10-18T15:09:01+08:00">2019-10-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2023-02-16 03:52:07" itemprop="dateModified" datetime="2023-02-16T03:52:07+08:00">2023-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/frontend/android/" itemprop="url" rel="index"><span itemprop="name">android</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/Blog/19-10-18-adb/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="19-10-18-adb/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>1k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>1 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="What"><a href="#What" class="headerlink" title="What"></a>What</h1><p>想看一下 某个包的文件</p>
<p>查看 usb连接&#x2F;模拟器 的设备 <code>adb devices</code></p>
<p>连接一个具体的设备 <code>adb -s &lt;设备id&gt; shell</code></p>
<p>列出手机里的安装包<code>pm list packages</code> 当然 grep命令也可以用</p>
<p>比如你要查看的包为<code>com.xxx.yyy</code>那么 <code>run-as com.xxx.yyy</code></p>
<p><code>cd ls grep cat</code>这些命令是有的 并没有vi XD,不过有cat 基本能看文件了</p>
<p>&#x2F;&#x2F; 搜到了 单个文件 cat 出来的 但没搜到文件夹的</p>
<p>&#x2F;&#x2F; 也有间接先cat到sdcard再pull 再删sdcard</p>
<p>&#x2F;&#x2F; 还搜到了一个 用 adb backup 把整个app搞出来，再 转换成tar的 [见下面链接]</p>
<p>&#x2F;&#x2F; 当然 还有一堆说root的 emmm 告辞</p>
<p>&#x2F;&#x2F; Stetho?</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/53634246/android-get-all-installed-packages-using-adb">https://stackoverflow.com/questions/53634246/android-get-all-installed-packages-using-adb</a></p>
<p><a target="_blank" rel="noopener" href="https://gist.github.com/davidnunez/1404789">https://gist.github.com/davidnunez/1404789</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/1043322/why-do-i-get-access-denied-to-data-folder-when-using-adb?rq=1">https://stackoverflow.com/questions/1043322/why-do-i-get-access-denied-to-data-folder-when-using-adb?rq=1</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/7399028/android-adb-permission-denied">https://stackoverflow.com/questions/7399028/android-adb-permission-denied</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/15558353/how-can-one-pull-the-private-data-of-ones-own-android-app">https://stackoverflow.com/questions/15558353/how-can-one-pull-the-private-data-of-ones-own-android-app</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/9017073/is-it-possible-to-see-application-data-from-adb-shell-the-same-way-i-see-it-moun/16461386">https://stackoverflow.com/questions/9017073/is-it-possible-to-see-application-data-from-adb-shell-the-same-way-i-see-it-moun/16461386</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/15558353/how-can-one-pull-the-private-data-of-ones-own-android-app/31504263#31504263">https://stackoverflow.com/questions/15558353/how-can-one-pull-the-private-data-of-ones-own-android-app/31504263#31504263</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://cromarmot.github.io/Blog/19-09-30-nikki4calc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/24691835?v=4">
      <meta itemprop="name" content="Cro-Marmot">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Blog/19-09-30-nikki4calc/" class="post-title-link" itemprop="url">闪耀暖暖 耗材计算器 rxjs + angular2+</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-09-30 15:09:01" itemprop="dateCreated datePublished" datetime="2019-09-30T15:09:01+08:00">2019-09-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2023-02-16 03:52:07" itemprop="dateModified" datetime="2023-02-16T03:52:07+08:00">2023-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/frontend/Angular/" itemprop="url" rel="index"><span itemprop="name">Angular</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/Blog/19-09-30-nikki4calc/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="19-09-30-nikki4calc/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>2.7k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>2 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="What"><a href="#What" class="headerlink" title="What"></a>What</h1><p>闪耀暖暖的设计师 材料耗材计算器</p>
<p>基于一个已经有的原生js 进行改造</p>
<p>原来生 <a target="_blank" rel="noopener" href="http://www.spongem.com/ajglz/tools/evalLevelUpCost.html">http://www.spongem.com/ajglz/tools/evalLevelUpCost.html</a></p>
<h1 id="重构内容"><a href="#重构内容" class="headerlink" title="重构内容"></a>重构内容</h1><ol start="0">
<li>首先把这个的源码 搞下来,比较无脑的操作</li>
<li>然后开个module 配一下routing</li>
<li>搞个component 然后把函数数据都搬进来</li>
<li>把相关全局变量 改为 <code>this.</code></li>
<li>修改原来的一些<code>$</code>方法 改为原生js,或者改为<code>[(ngModel)]</code>双向绑定，至此基本可以运行。</li>
<li>解构一下用户输入和计算输出分别叫做<code>Class: CardBasic/Card -&gt; html:Card/CardOut</code> &#x2F;&#x2F; 好吧 这里变量名有点乱 现在看来</li>
<li>引入<code>https://material.angular.io</code>的组件,稍微调整画风</li>
<li>尝试搞一个computed,移除计算按钮, 改为 <code>get XXX</code>的方法</li>
</ol>
<p>这里遇到问题, 根据调试，页面上的调用会反复调用get方法, 大量重复不必要计算</p>
<ol start="8">
<li>解决方案1: 引入Ramda，建立两个cache 分别是计算结果 和 用户输入，用 Ramda的深比较和深拷贝完成少的计算次数</li>
</ol>
<p>写着还好，行数不多，就能实现，性能也好，但是问题是，相当于你依然要去关心的是，输出值输入值直接的具体关系才能写。</p>
<ol start="9">
<li>解决方案2: 引入rxjs，用Observable搞</li>
</ol>
<p>这里实践上有些问题</p>
<ul>
<li>双向绑定如何和<code>BehaviorSubject</code>绑定,最后用<code>(ngModelChange)</code>来 单向到 具体字段</li>
<li>能否监听整个Class</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">of</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;rxjs&#x27;</span>;</span><br><span class="line"><span class="keyword">let</span> a = &#123;<span class="attr">x</span>:<span class="number">1</span>,<span class="attr">y</span>:<span class="number">2</span>&#125;;</span><br><span class="line"><span class="keyword">let</span> a$ = <span class="title function_">of</span>(a);</span><br><span class="line">a$.<span class="title function_">subscribe</span>(<span class="variable language_">console</span>.<span class="property">log</span>);</span><br><span class="line">a.<span class="property">x</span>=<span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p>例如这样 并不会因为修改了a的子字段而自动发送next</p>
<p>搞了半天最后还是 感觉很 手工写依赖的输入</p>
<p>这一块的实现主要如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 相当于所有用户输入的部分 都会对应一个emitter</span></span><br><span class="line">private <span class="attr">textEmitter</span>: <span class="title class_">Map</span>&lt;string, <span class="title class_">BehaviorSubject</span>&lt;string&gt;&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="comment">// 在初始化时 初始化它们并监听</span></span><br><span class="line">  <span class="comment">// initial textEmitter</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">card</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textEmitter</span>.<span class="title function_">set</span>(key, <span class="keyword">new</span> <span class="title class_">BehaviorSubject</span>(<span class="variable language_">this</span>.<span class="property">card</span>[key]));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">obAllKeys</span>(<span class="variable language_">this</span>.<span class="property">textEmitter</span>)</span><br><span class="line">    .<span class="title function_">pipe</span>(</span><br><span class="line">      <span class="title function_">map</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 细粒度触发 全体计算</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;fire calc&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">cardOut</span>; <span class="comment">// 就是最开始写的get方法 触发过程中只 告诉说 &#x27;哎!我变了!&#x27; 即可</span></span><br><span class="line">      &#125;)</span><br><span class="line">    ).<span class="title function_">subscribe</span>(<span class="variable language_">this</span>.<span class="property">cardOut$</span>); <span class="comment">// 页面通过这个读取 是个 BehaviorSubject</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 做的个功能 监听一个类 的所有字段 对应的 textEmitter的Observable</span></span><br><span class="line"><span class="comment">// 做了一点防抖</span></span><br><span class="line"><span class="title function_">obAllKeys</span>(<span class="attr">emitter</span>: <span class="title class_">Map</span>&lt;string, <span class="title class_">BehaviorSubject</span>&lt;string&gt;&gt;): <span class="title class_">Observable</span>&lt;string&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">mergeOb</span>: <span class="title class_">Observable</span>&lt;string&gt; = <span class="keyword">new</span> <span class="title class_">BehaviorSubject</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">  emitter.<span class="title function_">forEach</span>(<span class="function">(<span class="params">emitValue, emitKey</span>) =&gt;</span> &#123;</span><br><span class="line">    mergeOb = <span class="title function_">merge</span>(mergeOb, <span class="comment">// 关于merge的使用考虑 最开始想过使用combineLatest 但是 问题是 我明明可以直接通过 页面双向绑定拿到 用户输入,所以其实只需要一个变更通知即可，再另一个 combineLatest感觉要配上flat 才能 自动 绑定所有key,不然是手写的所有key,而对应的下标再反向生成 对象,表示 是不是有更好的方法 没学到没搜到</span></span><br><span class="line">      emitValue.<span class="title function_">pipe</span>(</span><br><span class="line">        <span class="title function_">debounceTime</span>(<span class="variable language_">this</span>.<span class="property">debounceInterval</span>),</span><br><span class="line">        <span class="title function_">distinctUntilChanged</span>(),</span><br><span class="line">        <span class="title function_">map</span>(<span class="function">(<span class="params">v</span>) =&gt;</span> emitKey + v) <span class="comment">// 这个是避免 在段时间内 上次状态a,  改b 改a 改回最初的a 这样就不会触发改变</span></span><br><span class="line">      ));</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> mergeOb.<span class="title function_">pipe</span>(<span class="title function_">debounceTime</span>(<span class="variable language_">this</span>.<span class="property">debounceInterval</span>)); <span class="comment">// 按理说一次只会改动一个  这个是初次进入时 会有多个 当然 combineLatest 不会有这个问题</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主要是和页面上的 输入绑定 具体就是 ngModelChange ,这一块的问题就是 写了 [(ngModel)] 又写了一遍这个绑定 光是key就要写两遍 还是字符串没法保证正确 靠的是下面的 调试强行保证部分</span></span><br><span class="line"><span class="title function_">onChange</span>(<span class="params">cardKey: string, value: string</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`onCardIdChange: <span class="subst">$&#123;cardKey&#125;</span> =&gt; <span class="subst">$&#123;value&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">textEmitter</span>.<span class="title function_">has</span>(cardKey)) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">textEmitter</span>.<span class="title function_">get</span>(cardKey).<span class="title function_">next</span>(value);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">// 调试用</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">&#x27;onChange&#x27;</span>, cardKey, value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>最后增加了一点 try catch,因为 不同的卡可选范围并不同，或者用户输入不合法会 爆红&#x3D;.&#x3D;只在 两个LevelVal里加了</li>
</ol>
<h1 id="最后结果"><a href="#最后结果" class="headerlink" title="最后结果"></a>最后结果</h1><p><a href="https://cromarmot.github.io/Debuq/#/nikki4/lvlup">https://cromarmot.github.io/Debuq/#/nikki4/lvlup</a></p>
<p>如果打开看到404，保持页面，等待一会儿再刷新即可。因为有worker service</p>
<h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><p>比如搞成动态拉取</p>
<p>计算函数再向纯函数靠拢啊</p>
<p>怎么json 转换 Class 甚至 Map &#x2F;&#x2F; 搜了一会没搜到简洁的方案</p>
<p>更好的双向绑定+BehaviorSubject 绑定?</p>
<p>是否可能简化某部分代码</p>
<p>输入控制 比如 现在其实可以输入 小数 和 范围以外的数</p>
<p>比如因为还是有不少json 导致 typescript的 类型判断并不完整 虽然</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://cromarmot.github.io/Blog/19-09-27-Dont_follow_RxJS_Best_Practices/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/24691835?v=4">
      <meta itemprop="name" content="Cro-Marmot">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Blog/19-09-27-Dont_follow_RxJS_Best_Practices/" class="post-title-link" itemprop="url">别遵循RxJS的最佳实践</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-09-27 01:01:01" itemprop="dateCreated datePublished" datetime="2019-09-27T01:01:01+08:00">2019-09-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2023-02-16 03:52:07" itemprop="dateModified" datetime="2023-02-16T03:52:07+08:00">2023-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/frontend/Angular/" itemprop="url" rel="index"><span itemprop="name">Angular</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/Blog/19-09-27-Dont_follow_RxJS_Best_Practices/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="19-09-27-Dont_follow_RxJS_Best_Practices/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>8.3k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>8 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h1><p><a target="_blank" rel="noopener" href="https://dev.to/nikpoltoratsky/don-t-follow-rxjs-best-practices-4893#pass-streams-to-children">英文原文</a></p>
<p><a href="/Blog/19-06-27-rxjs/">rxjs入门</a></p>
<h1 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h1><p>如今,越来越多开发者开始学 RxJs, 并跟随最佳实践正确使用它。但是完全不必要,那些所谓的最佳实践，需要学一些新的内容，并且在你的项目中增加额外的代码。</p>
<p>更多的是，使用最佳实践，是冒着创建好的代码库和让你的队友高兴的风险! 🌈</p>
<p>Stop being a gray mass! 打破常规，停止使用最佳实践</p>
<p>下面我将想你介绍，怎么改造那些所谓的最佳实践代码.</p>
<ul>
<li>不要unsubscribe</li>
<li>嵌套使用Subscribe</li>
<li>不要使用 纯函数</li>
<li>手动subscribe，不要使用 async pipe</li>
<li>向你的服务暴露subjects</li>
<li>始终对子组件传递流</li>
<li>宝石图? 并不适合你</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Blog/19-09-27-Dont_follow_RxJS_Best_Practices/#more" rel="contents">
                閱讀全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://cromarmot.github.io/Blog/19-09-23-redhat_gitlabserver_update/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/24691835?v=4">
      <meta itemprop="name" content="Cro-Marmot">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Blog/19-09-23-redhat_gitlabserver_update/" class="post-title-link" itemprop="url">redhat7 + gitlab-ce版本更新 11.6->12.2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-09-23 15:09:01" itemprop="dateCreated datePublished" datetime="2019-09-23T15:09:01+08:00">2019-09-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2023-02-16 03:52:07" itemprop="dateModified" datetime="2023-02-16T03:52:07+08:00">2023-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/software/" itemprop="url" rel="index"><span itemprop="name">software</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/software/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/Blog/19-09-23-redhat_gitlabserver_update/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="19-09-23-redhat_gitlabserver_update/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>2.5k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>2 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h1><p>模拟生产环境 尝试 升级 gitlab-ce 从 11.6 到 12.2, 以及尝试模拟之前产生的错误</p>
<p>官方说 先要到<code>11.11.X</code>再到<code>12.X</code></p>
<p>物料准备</p>
<p>vmware on Ubuntu 18.04 LTS</p>
<p>gitlab-ce-11.6.5-ce.0.el6.x86_64.rpm</p>
<p>gitlab-ce-11.11.0-ce.0.el6.x86_64.rpm</p>
<p>gitlab-ce-12.2.5-ce.0.el7.x86_64.rpm</p>
<p>rhel-server-7.7-x86_64-dvd.iso</p>
<h1 id="Install-OS"><a href="#Install-OS" class="headerlink" title="Install OS"></a>Install OS</h1><p><a target="_blank" rel="noopener" href="https://access.redhat.com/downloads/content/69/ver=/rhel---7/7.7/x86_64/product-software">https://access.redhat.com/downloads/content/69/ver=/rhel---7/7.7/x86_64/product-software</a></p>
<p>注册 下载 安装</p>
<p>需要注意的是 下4GB左右的 而不是boot.iso</p>
<blockquote>
<p>为什么是7 不是8(当前最新)</p>
</blockquote>
<p>因为想和某个生产环境保持一致 尝试 模拟某些操作</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Blog/19-09-23-redhat_gitlabserver_update/#more" rel="contents">
                閱讀全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://cromarmot.github.io/Blog/19-09-20-gitbiguselessfile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/24691835?v=4">
      <meta itemprop="name" content="Cro-Marmot">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Blog/19-09-20-gitbiguselessfile/" class="post-title-link" itemprop="url">git 在历史版本中 完全移除文件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-09-20 15:09:01" itemprop="dateCreated datePublished" datetime="2019-09-20T15:09:01+08:00">2019-09-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2023-02-16 03:52:07" itemprop="dateModified" datetime="2023-02-16T03:52:07+08:00">2023-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/software/" itemprop="url" rel="index"><span itemprop="name">software</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/software/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/Blog/19-09-20-gitbiguselessfile/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="19-09-20-gitbiguselessfile/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>966</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>1 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="How"><a href="#How" class="headerlink" title="How"></a>How</h1><p>参考</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/amiezhang/p/11337095.html">https://www.cnblogs.com/amiezhang/p/11337095.html</a></p>
<p>上面链接都有讲</p>
<p>按照文件大小排序前100:</p>
<p><code>git rev-list --objects --all | grep &quot;$(git verify-pack -v .git/objects/pack/*.idx | sort -k 3 -n | tail -100 | awk &#39;&#123;print$1&#125;&#39;)&quot;</code></p>
<p><code>git filter-branch --force --index-filter &#39;git rm --cached --ignore-unmatch 文件名&#39; --prune-empty --tag-name-filter cat -- --all</code></p>
<p><code>git filter-branch --index-filter</code> 让每个提交的文件都复制到索引(<code>.git/index</code>)中</p>
<p>然后运行过滤器命令：<code>git rm --cached --ignore-unmatch</code> 文件名 ，让每个提交都删除掉“文件名”文件</p>
<p>然后<code>--prune-empty</code>把空的提交“修剪”掉</p>
<p>然后<code>--tag-name-filter cat</code>把每个tag保持原名字，指向修改后的对应提交</p>
<p>最后<code>-- --all</code>将所有ref（包括branch、tag）都执行上面的重写</p>
<p><code>git for-each-ref --format=&#39;delete %(refname)&#39; refs/original | git update-ref --stdin</code></p>
<p><code>git reflog expire --expire=now --all</code></p>
<p><code>git gc --prune=now</code></p>
<h1 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h1><ol>
<li><p>上面的文件名可以写通配符号</p>
</li>
<li><p>众所周知只要我加到git中过的，即使把分支删了，也可以从reflog中找到，但这里 有 清除reflog所以 想要这样做的，要么 单独开文件夹搞，要么 确定 reflog都不会再用</p>
</li>
<li><p>什么时候使用? 使用频率不应高，因为 这种操作无疑是会对 分支重写，也就完全不同的commit hash,所以最后push都会带上–force, 目前能想到场景,比如 不必要的大文件,如不小心提交的下下来的打包后文件,大zip.也有场景 比如 很多分支前 不小心提交了一个涉密的文件。 当然push force以后 所有用仓库的人要想继续用只有去新的分支里搞了，已经被别人下的还会在别人硬盘里</p>
</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://cromarmot.github.io/Blog/19-09-15-A_Brief_History_of_Tomorrow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/24691835?v=4">
      <meta itemprop="name" content="Cro-Marmot">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Blog/19-09-15-A_Brief_History_of_Tomorrow/" class="post-title-link" itemprop="url">未来简史 阅读笔记</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-09-15 15:09:01" itemprop="dateCreated datePublished" datetime="2019-09-15T15:09:01+08:00">2019-09-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2023-02-16 03:52:07" itemprop="dateModified" datetime="2023-02-16T03:52:07+08:00">2023-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/notes/" itemprop="url" rel="index"><span itemprop="name">notes</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/notes/book/" itemprop="url" rel="index"><span itemprop="name">book</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/Blog/19-09-15-A_Brief_History_of_Tomorrow/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="19-09-15-A_Brief_History_of_Tomorrow/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>1.8k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>2 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>19-08-22  -&gt; 19-09-15</p>
</blockquote>
<p>ISBN:9787508672069</p>
<h1 id="Main"><a href="#Main" class="headerlink" title="Main"></a>Main</h1><p>回顾历史，发现很多现在有的，都是由各种其它混杂原因的组合</p>
<p>历史解决了三大 饥荒 瘟疫 战争</p>
<p>将可能考虑新的问题 永生 快乐</p>
<p>历史的解决问题的贡献，很多也用于人类升级</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Blog/19-09-15-A_Brief_History_of_Tomorrow/#more" rel="contents">
                閱讀全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://cromarmot.github.io/Blog/19-09-04-vuemsgbox/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/24691835?v=4">
      <meta itemprop="name" content="Cro-Marmot">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Blog/19-09-04-vuemsgbox/" class="post-title-link" itemprop="url">eleme vue msgbox 简单看看实现原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-09-04 11:20:14" itemprop="dateCreated datePublished" datetime="2019-09-04T11:20:14+08:00">2019-09-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2023-02-16 03:52:07" itemprop="dateModified" datetime="2023-02-16T03:52:07+08:00">2023-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/frontend/vue2/" itemprop="url" rel="index"><span itemprop="name">vue2</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/Blog/19-09-04-vuemsgbox/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="19-09-04-vuemsgbox/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>2.3k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>2 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="依赖版本"><a href="#依赖版本" class="headerlink" title="依赖版本"></a>依赖版本</h1><p>element-ui 版本 10592d12ea981912165542920160669fd8874bd9</p>
<p>文档 <a target="_blank" rel="noopener" href="https://element.eleme.io/#/zh-CN/component/message-box">https://element.eleme.io/#/zh-CN/component/message-box</a></p>
<h1 id="要解决的问题"><a href="#要解决的问题" class="headerlink" title="要解决的问题"></a>要解决的问题</h1><p>像是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$msgbox(options)</span><br><span class="line">$alert(message, title, options) 或 $alert(message, options)</span><br><span class="line">$confirm(message, title, options) 或 $confirm(message, options)</span><br><span class="line">$prompt(message, title, options) 或 $prompt(message, options)</span><br></pre></td></tr></table></figure>

<p>这样的api是怎么实现的</p>
<h1 id="代码阅读"><a href="#代码阅读" class="headerlink" title="代码阅读"></a>代码阅读</h1><p>大概看一眼怎么搞的</p>
<p><code>src/index.js</code> 看 这些方法 ,都是来自 <code>import MessageBox from &#39;../packages/message-box/index.js&#39;;</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$msgbox</span> = <span class="title class_">MessageBox</span>;</span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$alert</span> = <span class="title class_">MessageBox</span>.<span class="property">alert</span>;</span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$confirm</span> = <span class="title class_">MessageBox</span>.<span class="property">confirm</span>;</span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$prompt</span> = <span class="title class_">MessageBox</span>.<span class="property">prompt</span>;</span><br></pre></td></tr></table></figure>

<p>那么看 <code>packages/message-box/src</code>文件夹</p>
<p>两个文件 <code>main.js</code>和 <code>main.vue</code></p>
<p><code>main.vue</code>瞄一眼,都是我们常见的写法</p>
<p><code>main.js</code>，看这些方法 最后 都是 调用 <code>MessageBox(配置参数)</code>的形式调用</p>
<p>再看<code>const MessageBox = function(options, callback) &#123;</code>的实现</p>
<p>都是 先<code>msgQueue.push(配置参数) + showNextMsg()</code></p>
<p><code>msgQueue</code>和 <code>showNextMsg</code>,分别是个数组，和从数组中<code>shift()</code> 取出值 进行具体展示执行</p>
<p>然后 看 <code>showNextMsg()</code> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (!instance) &#123;</span><br><span class="line">  initInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const initInstance = () =&gt; &#123;</span><br><span class="line">  instance = new MessageBoxConstructor(&#123;</span><br><span class="line">    el: document.createElement(&#x27;div&#x27;)</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  instance.callback = defaultCallback;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>和</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const MessageBoxConstructor = Vue.extend(msgboxVue);</span><br></pre></td></tr></table></figure>

<p>说明了基本这就是 工厂模式+单例模式+<code>Vue.extend</code>来创建弹框单例,所以我们页面上不需要写什么,就能直接调用</p>
<p>然后这些<code>confirm</code>调用过程 也就是对这个单例的参数改动 比如控制样式 数据 显示之类的</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol>
<li>用户调用 <code>$msgbox</code></li>
<li>调用到<code>packages/message-box/src/main.js</code>的 <code>MessageBox(options,callback)</code></li>
<li><code>MessageBox(options,callback)</code>通过 数组 + 数组.shift,依次提取数据展示</li>
<li>对于展示的实例 是 通过 <code>Vue.extend(packages/message-box/src/main.vue)</code> + 工厂单例来产生的一个实例</li>
<li>他们 搞了一个<code>element/examples/components/demo-block.vue</code> 可以在<code>markdown</code>写示例代码,并且在网页上查看 可以运行 66666</li>
</ol>
<blockquote>
<p>那常见的问题可能有说，连续调用2此带有回调函数的<code>$msgbox</code>会怎样</p>
</blockquote>
<p>我们可以看<code>showNextMsg()</code>实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//得到 instance</span></span><br><span class="line">  <span class="keyword">if</span> (!instance.<span class="property">visible</span> || instance.<span class="property">closeTimer</span>) &#123;</span><br><span class="line"> <span class="comment">//...</span></span><br><span class="line">      <span class="keyword">let</span> oldCb = instance.<span class="property">callback</span>;</span><br><span class="line">      instance.<span class="property">callback</span> = <span class="function">(<span class="params">action, instance</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">oldCb</span>(action, instance);</span><br><span class="line">        <span class="title function_">showNextMsg</span>();</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      <span class="title class_">Vue</span>.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        instance.<span class="property">visible</span> = <span class="literal">true</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="comment">//...</span></span><br></pre></td></tr></table></figure>


<p>意思就是如果我们同步调用两个，</p>
<ul>
<li>因为我们visible设置为true是 异步里发生的,那么 这两个调用时 visible默认都是false,所以 只会最后一个生效</li>
<li>如果我们异步调用两次msgbox,那么 后一个调用 会在<code>!visible</code>的地方为false,不会直接触发，但是因为设计了msgQueue,因此 会放在数组中，然后看到 上面的callback,会在调用oldCb以后 再调用showNextMsg,所以会在对话框回调以后 再回调 那个时刻，msgQueue里首个 并从数组中移除</li>
</ul>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><blockquote>
<p>总流程实现</p>
</blockquote>
<p>也就是方法是<code>src/index.js</code>: <code>Vue.prototype.方法名 = 方法函数</code> 来让全局可用</p>
<p>通过 <code>document.createElement(&#39;div&#39;)</code> 和 全局变量, 创建绑定维护对应的单例实例.</p>
<p>这样就实现了 任何页面,不需要写组件,就能<code>this.方法名(参数)</code> 来弹窗</p>
<p>适用场景,不需要业务定UI,否则需要页面<code>v-slot</code>之类插入业务内容</p>
<blockquote>
<p>参数设计(核心参数与可选参数与回调)</p>
</blockquote>
<p>核心参数是函数的直接参数</p>
<p>可选参数组合成一个对象,提供默认值</p>
<p>回调既有成功也有失败,随是promise,总觉得用reject来做取消和关闭其实不太好, 可以全resolve走自定义状态</p>
<p>提供一定的重载实现</p>
<blockquote>
<p>内部具体</p>
</blockquote>
<p>队列, 同步异步, callback持有</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://cromarmot.github.io/Blog/19-09-02-git_subtree_vs_submodule/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/24691835?v=4">
      <meta itemprop="name" content="Cro-Marmot">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Blog/19-09-02-git_subtree_vs_submodule/" class="post-title-link" itemprop="url">git subtree vs submodule</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-09-02 11:20:14" itemprop="dateCreated datePublished" datetime="2019-09-02T11:20:14+08:00">2019-09-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2023-02-16 03:52:07" itemprop="dateModified" datetime="2023-02-16T03:52:07+08:00">2023-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/software/" itemprop="url" rel="index"><span itemprop="name">software</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/software/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/Blog/19-09-02-git_subtree_vs_submodule/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="19-09-02-git_subtree_vs_submodule/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>443</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>1 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><h2 id="submodule"><a href="#submodule" class="headerlink" title="submodule"></a>submodule</h2><p><code>git submodule add 仓库url</code></p>
<p><code>git diff --cached --submodule</code></p>
<p>clone后</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git submodule init</span><br><span class="line">git submodule update</span><br></pre></td></tr></table></figure>

<p>clone时自动 拉取<code>git clone --recurse-submodules</code></p>
<p><code>git log -p --submodule</code></p>
<h2 id="subtree"><a href="#subtree" class="headerlink" title="subtree"></a>subtree</h2><p><code>git subtree add --squash --prefix=文件夹名 仓库url 分支名</code></p>
<p>分割</p>
<p><code>git subtree split --prefix=文件夹名 -b 分支名</code></p>
<p>配合remote使用</p>
<h1 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h1><table>
<thead>
<tr>
<th>subtree</th>
<th>submodule</th>
</tr>
</thead>
<tbody><tr>
<td>相当于拷贝文件甚至commit到当前仓库</td>
<td>相当于只记录了另一个仓库的某个提交的指针</td>
</tr>
<tr>
<td>因此 pull容易push难</td>
<td>push容易pull难</td>
</tr>
</tbody></table>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://git-scm.com/book/en/v2/Git-Tools-Submodules">https://git-scm.com/book/en/v2/Git-Tools-Submodules</a></p>
<p><a target="_blank" rel="noopener" href="https://git-scm.com/book/en/v1/Git-Tools-Subtree-Merging">https://git-scm.com/book/en/v1/Git-Tools-Subtree-Merging</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://cromarmot.github.io/Blog/19-08-30-vuerouter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars.githubusercontent.com/u/24691835?v=4">
      <meta itemprop="name" content="Cro-Marmot">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Cro-Marmot's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Blog/19-08-30-vuerouter/" class="post-title-link" itemprop="url">vue router 源码阅读</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">發表於</span>

      <time title="創建時間：2019-08-30 11:20:14" itemprop="dateCreated datePublished" datetime="2019-08-30T11:20:14+08:00">2019-08-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新於</span>
      <time title="修改時間：2023-02-16 03:52:07" itemprop="dateModified" datetime="2023-02-16T03:52:07+08:00">2023-02-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分類於</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/Blog/categories/frontend/vue2/" itemprop="url" rel="index"><span itemprop="name">vue2</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/Blog/19-08-30-vuerouter/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="19-08-30-vuerouter/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="文章字數">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">文章字數：</span>
      <span>26k</span>
    </span>
    <span class="post-meta-item" title="所需閱讀時間">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">所需閱讀時間 &asymp;</span>
      <span>24 分鐘</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文对应版本 <code>638278b334199f17e052a54a0837c97624940c0c</code></p>
<blockquote>
<p>获得代码</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">git remote add origin https://github.com/vuejs/vue-router.git</span><br><span class="line">git fetch origin 638278b334199f17e052a54a0837c97624940c0c</span><br><span class="line">git reset --hard FETCH_HEAD</span><br></pre></td></tr></table></figure>

<h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><p><a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/mixins.html">https://cn.vuejs.org/v2/guide/mixins.html</a></p>
<p><a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/plugins.html">https://cn.vuejs.org/v2/guide/plugins.html</a></p>
<h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><table>
<thead>
<tr>
<th align="right">行数</th>
<th align="left">文件</th>
</tr>
</thead>
<tbody><tr>
<td align="right">262</td>
<td align="left"><a href="#install-js">index.js</a></td>
</tr>
<tr>
<td align="right">200</td>
<td align="left"><a href="#create-matcher-js">create-matcher.js</a></td>
</tr>
<tr>
<td align="right">353</td>
<td align="left"><a href="#base-js">history&#x2F;base.js</a></td>
</tr>
<tr>
<td align="right">22</td>
<td align="left"><a href="#errors-js">history&#x2F;errors.js</a></td>
</tr>
<tr>
<td align="right">69</td>
<td align="left"><a href="#abstract-js">history&#x2F;abstract.js</a></td>
</tr>
<tr>
<td align="right">80</td>
<td align="left"><a href="#html5-js">history&#x2F;html5.js</a></td>
</tr>
<tr>
<td align="right">157</td>
<td align="left"><a href="#hash-js">history&#x2F;hash.js</a></td>
</tr>
<tr>
<td align="right">190</td>
<td align="left"><a href="#link-js">components&#x2F;link.js</a></td>
</tr>
<tr>
<td align="right">124</td>
<td align="left"><a href="#view-js">components&#x2F;view.js</a></td>
</tr>
<tr>
<td align="right">52</td>
<td align="left"><a href="#install-js">install.js</a></td>
</tr>
<tr>
<td align="right">193</td>
<td align="left"><a href="#create-route-map-js">create-route-map.js</a></td>
</tr>
<tr>
<td align="right">6</td>
<td align="left"><a href="#misc-js">util&#x2F;misc.js</a></td>
</tr>
<tr>
<td align="right">95</td>
<td align="left"><a href="#query-js">util&#x2F;query.js</a></td>
</tr>
<tr>
<td align="right">3</td>
<td align="left"><a href="#dom-js">util&#x2F;dom.js</a></td>
</tr>
<tr>
<td align="right">25</td>
<td align="left"><a href="#warn-js">util&#x2F;warn.js</a></td>
</tr>
<tr>
<td align="right">152</td>
<td align="left"><a href="#scroll-js">util&#x2F;scroll.js</a></td>
</tr>
<tr>
<td align="right">35</td>
<td align="left"><a href="#params-js">util&#x2F;params.js</a></td>
</tr>
<tr>
<td align="right">132</td>
<td align="left"><a href="#route-js">util&#x2F;route.js</a></td>
</tr>
<tr>
<td align="right">64</td>
<td align="left"><a href="#location-js">util&#x2F;location.js</a></td>
</tr>
<tr>
<td align="right">22</td>
<td align="left"><a href="#state-key-js">util&#x2F;state-key.js</a></td>
</tr>
<tr>
<td align="right">18</td>
<td align="left"><a href="#async-js">util&#x2F;async.js</a></td>
</tr>
<tr>
<td align="right">42</td>
<td align="left"><a href="#push-state-js">util&#x2F;push-state.js</a></td>
</tr>
<tr>
<td align="right">74</td>
<td align="left"><a href="#path-js">util&#x2F;path.js</a></td>
</tr>
<tr>
<td align="right">108</td>
<td align="left"><a href="#resolve-components-js">util&#x2F;resolve-components.js</a></td>
</tr>
</tbody></table>
<p>总共2478行 </p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">src/</span><br><span class="line">├── components</span><br><span class="line">│   ├── link.js 控制url显示</span><br><span class="line">│   └── view.js 控制页面渲染</span><br><span class="line">├── create-matcher.js 路由匹配</span><br><span class="line">├── create-route-map.js</span><br><span class="line">├── history</span><br><span class="line">│   ├── abstract.js</span><br><span class="line">│   ├── base.js</span><br><span class="line">│   ├── errors.js</span><br><span class="line">│   ├── hash.js</span><br><span class="line">│   └── html5.js</span><br><span class="line">├── index.js 包含 VueRouter 类</span><br><span class="line">├── install.js 日常mixin</span><br><span class="line">└── util</span><br><span class="line">    ├── async.js</span><br><span class="line">    ├── dom.js</span><br><span class="line">    ├── location.js</span><br><span class="line">    ├── misc.js</span><br><span class="line">    ├── params.js</span><br><span class="line">    ├── path.js</span><br><span class="line">    ├── push-state.js</span><br><span class="line">    ├── query.js</span><br><span class="line">    ├── resolve-components.js</span><br><span class="line">    ├── route.js</span><br><span class="line">    ├── scroll.js</span><br><span class="line">    ├── state-key.js</span><br><span class="line">    └── warn.js</span><br></pre></td></tr></table></figure>

<p>回顾那个只有1100行左右的vuex源码，你发现 除了两者都有<code>index.js</code>,其它目录结构大不相同了</p>
<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><p>首先我们看一段代码，最好先了解它的功能，所以没有用过vue-router的建议先照着tutorial知道它大概的功能</p>
<p>然后看看源码里的demo:</p>
<p>在<code>npm install</code>后 <code>PORT=8085 npm run dev</code>即可在<code>localhost:8085</code>上查看，把上面每个example都看一看</p>
<p>然后就可以看看flow文件夹里的，也不长,’类’的数量也不多，通过阅读flow的文件，你可以对 整个router有个印象</p>
<p>从代码使用上看</p>
<ul>
<li>实例类router</li>
<li>配置路径 和 对应component</li>
<li>页面<code>&lt;router-view&gt;</code>,<code>&lt;router-link&gt;</code> 以及 a标签等跳转</li>
<li>Vue.use(VueRouter) &#x2F;&#x2F; 注册插件</li>
<li>new Vue({router传入实例})</li>
</ul>
<p>this上会有<code>$route</code>和<code>$router</code></p>
<h1 id="src-x2F"><a href="#src-x2F" class="headerlink" title="src&#x2F;"></a>src&#x2F;</h1><h2 id="代码阅读"><a href="#代码阅读" class="headerlink" title="代码阅读"></a>代码阅读</h2><ol>
<li>先看<a href="#install-js">install.js</a>,调用<code>Vue.mixin</code> 注入</li>
<li>然后<a href="#index-js">index.js</a>, 看完这一部分基本 就大概看到了 主要是靠XXXHistory来 实现 <code>this.history</code>然后方法 不少只是对 <code>this.history</code>的方法转发</li>
<li>既然知道了主要是XXXHistory来实现，那么 反过来 先按照顺序看<a href="#util">util</a>文件夹,伴随着test里的测试用例看完util的代码,把大多代码看懂即可，少部分比较复杂也没有测试用例的大自看看</li>
<li>然后看<code>history</code>的代码,顺序就<a href="#errors-js">errors.js</a> ,<a href="#base-js">base.js</a>,最后 <code>abstract/hash/html5</code>这三个任意顺序</li>
<li>然后是两个<code>create-*.js</code>，工具人 工具函数</li>
<li>最后看两个<code>components</code></li>
</ol>
<p><strong>下面目录是按字典序排列的,不是按照阅读顺序</strong></p>
<h2 id="components"><a href="#components" class="headerlink" title="components"></a>components</h2><h3 id="link-js"><a href="#link-js" class="headerlink" title="link.js"></a>link.js</h3><p>emmm, <code>noop = ()=&gt;&#123;&#125;</code></p>
<p>所以 也就会想到说 ，是 函数内 增加一堆if来处理 有值 无值 空值，还是说 强行要求传入符合格式,这两种方式 如何选择</p>
<p>也就是 render函数</p>
<p>可以看到 有从 初始化的options中 读取 linkActiveClass&#x2F;linkExactActiveClass用什么 或者用默认的<code>router-link-active</code>&#x2F;<code>router-link-exact-active</code></p>
<p>这里实现了一个 <code>guardEvent(e)</code> 不会拦截 <code>metaKey,altKey,ctrlKey,shiftKey</code>等等</p>
<p>当拦截时，执行replace或者push</p>
<p>定义变量on配置了click和 传入的event或event数组里所有事件 调用 handler也就是 guardEvent</p>
<p>这里通过 <code>this.$scopedSlots.default(&#123;</code> 拿去默认slot</p>
<p>然后对它渲染， 这里又可以看到 如果有多个default slot,在production时会报warn</p>
<p>然后 props的tag默认是’a’标签，</p>
<p>如果是 <code>tag==&#39;a&#39;</code>那么 绑上<code>on</code>和<code>attrs</code></p>
<p>如果不是<code>tag==&#39;a&#39;</code> 则<code>// find the first &lt;a&gt; child and apply listener and href</code></p>
<p><code>const a = findAnchor(this.$slots.default)</code> 递归 找第一个 achild</p>
<p>如果没找到<code>data.on = on;</code></p>
<p>最后 调用 <code>h(this.tag, data包含了on class 等等, this.$slots.default)</code> </p>
<p>其中提供 的两个辅助函数 <code>guardEvent</code>和<code>findAnchor</code>分别时 用来 拦截默认 a标签事件和 深搜找到首个a标签的</p>
<h3 id="view-js"><a href="#view-js" class="headerlink" title="view.js"></a>view.js</h3><p>也就是 渲染html上的 <code>RouterView</code> 或者说<code>&lt;router-view&gt;</code></p>
<p>functional:true</p>
<p>意味着 没有响应式数据，没有this上下文</p>
<p><a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/guide/render-function.html#%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6">https://cn.vuejs.org/v2/guide/render-function.html#%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BB%84%E4%BB%B6</a></p>
<p>接受一个props, </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name</span>: &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">  <span class="attr">default</span>: <span class="string">&#x27;default&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到接受的render 也和 link的不一样,link的是 <code>render(h)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">render (_, &#123; props, children, parent, data &#125;) &#123;</span><br></pre></td></tr></table></figure>

<p>给devtools用的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// used by devtools to display a router-view badge</span></span><br><span class="line">data.<span class="property">routerView</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>因为没有this,没有接受 h ，这里是通过 <code>h = parent.$createElement</code></p>
<p>此外 <code>$route</code>,<code>_routerViewCache</code>也是从 parent拿的 </p>
<p>通过 比较 <code>parent == parent._routerRoot</code> 来看parent是否为根节点,并递归向上找根节点</p>
<p>如果 某个祖先上有<code>parent.$vnode.data.routerView</code> 那么 <code>深度计数++</code></p>
<p>如果 某个祖先上有<code>parent.$vnode.data.keepAlive</code>且<code>parent._inactive</code> 那么 inactive标识为 true</p>
<p><code>data.routerViewDepth = 深度计数</code></p>
<p>如果非活跃</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (inactive) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">h</span>(cache[name], data, children)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 <code>$route.matched[深度]</code> 当前的路由的matched数组</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> matched = route.<span class="property">matched</span>[depth]</span><br><span class="line"><span class="comment">// render empty node if no matched route</span></span><br><span class="line"><span class="keyword">if</span> (!matched) &#123;</span><br><span class="line">  cache[name] = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">h</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新cache指针</p>
<p><code>const component = cache[name] = matched.components[name]</code></p>
<p>也就是 我们在<code>src/install.js</code>中看到的 <code>registerRouteInstance</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// attach instance registration hook</span></span><br><span class="line"><span class="comment">// this will be called in the instance&#x27;s injected lifecycle hooks</span></span><br><span class="line">data.<span class="property">registerRouteInstance</span> = <span class="function">(<span class="params">vm, val</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// val could be undefined for unregistration</span></span><br><span class="line">  <span class="keyword">const</span> current = matched.<span class="property">instances</span>[name]</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (val &amp;&amp; current !== vm) ||</span><br><span class="line">    (!val &amp;&amp; current === vm)</span><br><span class="line">  ) &#123;</span><br><span class="line">    matched.<span class="property">instances</span>[name] = val</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册 prepatch 和 init的钩子,这个一个应该是 vue相关的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// also register instance in prepatch hook</span></span><br><span class="line"><span class="comment">// in case the same component instance is reused across different routes</span></span><br><span class="line">;(data.<span class="property">hook</span> || (data.<span class="property">hook</span> = &#123;&#125;)).<span class="property">prepatch</span> = <span class="function">(<span class="params">_, vnode</span>) =&gt;</span> &#123;</span><br><span class="line">  matched.<span class="property">instances</span>[name] = vnode.<span class="property">componentInstance</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// register instance in init hook</span></span><br><span class="line"><span class="comment">// in case kept-alive component be actived when routes changed</span></span><br><span class="line">data.<span class="property">hook</span>.<span class="property">init</span> = <span class="function">(<span class="params">vnode</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (vnode.<span class="property">data</span>.<span class="property">keepAlive</span> &amp;&amp;</span><br><span class="line">    vnode.<span class="property">componentInstance</span> &amp;&amp;</span><br><span class="line">    vnode.<span class="property">componentInstance</span> !== matched.<span class="property">instances</span>[name]</span><br><span class="line">  ) &#123;</span><br><span class="line">    matched.<span class="property">instances</span>[name] = vnode.<span class="property">componentInstance</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只搜到了 <code>https://github.com/vuejs/vue/issues/8657</code></p>
<p>最后是 传递<code>matched.props[name]</code>的内容</p>
<p>具体代码就是 把在data.props中,不在 components.props中的 key以及对应的值搬运到 data.attrs里</p>
<p>最后 <code>return h(component, data, children)</code></p>
<blockquote>
<p>层级<code>router-view</code>实现原理</p>
</blockquote>
<p><code>index.js -&gt; createMatcher-&gt; createRoute -&gt; .matched = record ? formatMatch(record) : []</code></p>
<p>其中record是 RouteRecord类型,formatMatch通过 递归 parent 来把 它变 数组</p>
<p>其中parent的来源 是<code>create-route-map</code>中 <code>addRouteRecord</code>递归计算的</p>
<p>然后 在 解析 元素时 可以通过当前 <code>$route.matched[depth]</code>直接获得实例</p>
<h2 id="create-matcher-js"><a href="#create-matcher-js" class="headerlink" title="create-matcher.js"></a>create-matcher.js</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createMatcher</span> (</span><br><span class="line">  <span class="attr">routes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteConfig</span>&gt;,</span><br><span class="line">  <span class="attr">router</span>: <span class="title class_">VueRouter</span></span><br><span class="line">): <span class="title class_">Matcher</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; pathList, pathMap, nameMap &#125; = <span class="title function_">createRouteMap</span>(routes)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">match</span> (</span><br><span class="line">  <span class="attr">raw</span>: <span class="title class_">RawLocation</span>,</span><br><span class="line">  currentRoute?: <span class="title class_">Route</span>,</span><br><span class="line">  redirectedFrom?: <span class="title class_">Location</span></span><br><span class="line">): <span class="title class_">Route</span> &#123;</span><br></pre></td></tr></table></figure>

<p><code>匹配name(nameMap找) -&gt; 匹配 location.path(pathList + pathMap) -&gt; create 一个新的Route</code></p>
<p>这里用list 也可以看出 这里期望的个数应该要小(?)，否则效率O(n)大了性能会较差?(不过O(n*操作)似乎1000个也不会很久? 反正这也不是频繁操作?所以不用在意?</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">redirect</span> (</span><br><span class="line">  <span class="attr">record</span>: <span class="title class_">RouteRecord</span>,</span><br><span class="line">  <span class="attr">location</span>: <span class="title class_">Location</span></span><br><span class="line">): <span class="title class_">Route</span> &#123;</span><br></pre></td></tr></table></figure>

<p>同样是<code>redirect（record.redirect）</code>中的 name匹配 path匹配</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">alias</span> (</span><br><span class="line">  <span class="attr">record</span>: <span class="title class_">RouteRecord</span>,</span><br><span class="line">  <span class="attr">location</span>: <span class="title class_">Location</span>,</span><br><span class="line">  <span class="attr">matchAs</span>: string</span><br><span class="line">): <span class="title class_">Route</span> &#123;</span><br></pre></td></tr></table></figure>

<p>通过匹配 <code>fillParams(matchAs, location.params,...)</code> 到path 同样返回Route</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">_createRoute</span> (</span><br><span class="line">  <span class="attr">record</span>: ?<span class="title class_">RouteRecord</span>,</span><br><span class="line">  <span class="attr">location</span>: <span class="title class_">Location</span>,</span><br><span class="line">  redirectedFrom?: <span class="title class_">Location</span></span><br><span class="line">): <span class="title class_">Route</span> &#123;</span><br></pre></td></tr></table></figure>

<p>再调用 <code>真的createRoute</code> 或者 调上面的 <code>redirect/alias</code> 只要 <code>record.redirect/matchAs</code>存在， 也就是 可能产生无限循环?的了 </p>
<h2 id="create-route-map-js"><a href="#create-route-map-js" class="headerlink" title="create-route-map.js"></a>create-route-map.js</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createRouteMap</span> (</span><br><span class="line">  <span class="attr">routes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteConfig</span>&gt;,</span><br><span class="line">  oldPathList?: <span class="title class_">Array</span>&lt;string&gt;,</span><br><span class="line">  oldPathMap?: <span class="title class_">Dictionary</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span><br><span class="line">  oldNameMap?: <span class="title class_">Dictionary</span>&lt;<span class="title class_">RouteRecord</span>&gt;</span><br><span class="line">): &#123;</span><br><span class="line">  <span class="attr">pathList</span>: <span class="title class_">Array</span>&lt;string&gt;,</span><br><span class="line">  <span class="attr">pathMap</span>: <span class="title class_">Dictionary</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span><br><span class="line">  <span class="attr">nameMap</span>: <span class="title class_">Dictionary</span>&lt;<span class="title class_">RouteRecord</span>&gt;</span><br><span class="line">&#125; &#123;</span><br></pre></td></tr></table></figure>

<p>还会自动把 <code>&#39;*&#39;</code> wildcard routes 放到最后</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">addRouteRecord</span> (</span><br><span class="line">  <span class="attr">pathList</span>: <span class="title class_">Array</span>&lt;string&gt;,</span><br><span class="line">  <span class="attr">pathMap</span>: <span class="title class_">Dictionary</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span><br><span class="line">  <span class="attr">nameMap</span>: <span class="title class_">Dictionary</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span><br><span class="line">  <span class="attr">route</span>: <span class="title class_">RouteConfig</span>,</span><br><span class="line">  parent?: <span class="title class_">RouteRecord</span>,</span><br><span class="line">  matchAs?: string</span><br><span class="line">) &#123;</span><br></pre></td></tr></table></figure>

<p>为什么 其他地方 都是直接 用true&#x2F;false,这边 <code>route.caseSensitive</code>要判断<code>typeof === &#39;boolean&#39;</code></p>
<p>递归对<code>.children</code>节点调用 addRouteRecord</p>
<p>这两个函数 主要是封装 对 传入的 pathList,pathMap,nameMap 这些 进行 添加</p>
<p>因为处理了没有传值的情况，所以也可以用于初始化</p>
<h2 id="history"><a href="#history" class="headerlink" title="history"></a>history</h2><h3 id="abstract-js"><a href="#abstract-js" class="headerlink" title="abstract.js"></a>abstract.js</h3><p>正如其名,所有浏览器上地址栏,url，scroll都没有了,取代的 是 实现了 <code>stack:Array&lt;Route&gt;</code>和<code>index:number</code></p>
<h3 id="base-js"><a href="#base-js" class="headerlink" title="base.js"></a>base.js</h3><p>是整个源码中最大的单个文件了, <code>hash/html5/abstract</code> 这三个 都是基于base实现的,反过来想在 index.js中我们有看到根据模式不同 把<code>this.history</code> 赋予了不同的值 也就会想要这三个有共同的基类</p>
<p>对外只提供一个History类</p>
<p>这些 加号 是干嘛的,我看flow的文档只看到 说 readonly,是我没有找到正确的位置吗</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// implemented by sub-classes</span></span><br><span class="line">+<span class="attr">go</span>: <span class="function">(<span class="params">n: number</span>) =&gt;</span> <span class="keyword">void</span></span><br><span class="line">+<span class="attr">push</span>: <span class="function">(<span class="params">loc: RawLocation</span>) =&gt;</span> <span class="keyword">void</span></span><br><span class="line">+<span class="attr">replace</span>: <span class="function">(<span class="params">loc: RawLocation</span>) =&gt;</span> <span class="keyword">void</span></span><br><span class="line">+<span class="attr">ensureURL</span>: <span class="function">(<span class="params">push?: boolean</span>) =&gt;</span> <span class="keyword">void</span></span><br><span class="line">+<span class="attr">getCurrentLocation</span>: <span class="function">() =&gt;</span> string</span><br></pre></td></tr></table></figure>

<p>初始化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span> (<span class="attr">router</span>: <span class="title class_">Router</span>, <span class="attr">base</span>: ?string) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">router</span> = router</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">base</span> = <span class="title function_">normalizeBase</span>(base)</span><br><span class="line">  <span class="comment">// start with a route object that stands for &quot;nowhere&quot;</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">current</span> = <span class="variable constant_">START</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">pending</span> = <span class="literal">null</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">ready</span> = <span class="literal">false</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">readyCbs</span> = []</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">readyErrorCbs</span> = []</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">errorCbs</span> = []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>listen(cb)</code> 简单粗暴 直接 <code>this.cb=cb</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onReady (<span class="attr">cb</span>: <span class="title class_">Function</span>, <span class="attr">errorCb</span>: ?<span class="title class_">Function</span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>如果当前ready同步执行cb,否则<code>readyCbs</code>数组push进cb,错误回调push进<code>readyErrorCbs</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onError (<span class="attr">errorCb</span>: <span class="title class_">Function</span>) &#123;<span class="string">`</span></span><br></pre></td></tr></table></figure>

<p>push进<code>errorCbs</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">transitionTo (</span><br><span class="line">  <span class="attr">location</span>: <span class="title class_">RawLocation</span>,</span><br><span class="line">  onComplete?: <span class="title class_">Function</span>,</span><br><span class="line">  onAbort?: <span class="title class_">Function</span></span><br><span class="line">) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>调用 <code>confirmTransition</code></p>
<p>成功执行<code>this.updateRoute(route)</code> &amp; <code>onComplete(route)</code> &amp; <code>this.ensureURL()</code>调用所有 <code>readyCbs</code> Once</p>
<p>失败<code>onAbort(err)</code> 所有<code>readyErrorCbs</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">confirmTransition (<span class="attr">route</span>: <span class="title class_">Route</span>, <span class="attr">onComplete</span>: <span class="title class_">Function</span>, onAbort?: <span class="title class_">Function</span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>如果目标和当前Route一样, 触发 <code>NavigationDuplicated(route)</code>,调用<code>errorCbs</code>再 调用<code>onAbort(err)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; updated, deactivated, activated &#125; = <span class="title function_">resolveQueue</span>(</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">current</span>.<span class="property">matched</span>,</span><br><span class="line">  route.<span class="property">matched</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="attr">queue</span>: <span class="title class_">Array</span>&lt;?<span class="title class_">NavigationGuard</span>&gt; = [].<span class="title function_">concat</span>(</span><br><span class="line">  <span class="comment">// in-component leave guards</span></span><br><span class="line">  <span class="title function_">extractLeaveGuards</span>(deactivated),</span><br><span class="line">  <span class="comment">// global before hooks</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">router</span>.<span class="property">beforeHooks</span>,</span><br><span class="line">  <span class="comment">// in-component update hooks</span></span><br><span class="line">  <span class="title function_">extractUpdateHooks</span>(updated),</span><br><span class="line">  <span class="comment">// in-config enter guards</span></span><br><span class="line">  activated.<span class="title function_">map</span>(<span class="function"><span class="params">m</span> =&gt;</span> m.<span class="property">beforeEnter</span>),</span><br><span class="line">  <span class="comment">// async components</span></span><br><span class="line">  <span class="title function_">resolveAsyncComponents</span>(activated)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>设计了一个<code>iterator</code>函数,用<code>runQueue</code>对上面<code>queue</code>进行执行</p>
<p>真是艹了 就非要重复使用变量名吗？？ 这里queue</p>
<p>上面的每个如果都成功了，那么执行</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">extractEnterGuards</span>(activated, postEnterCbs, <span class="function">()=&gt;</span> <span class="variable language_">this</span>.<span class="property">current</span> === route)</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">router</span>.<span class="property">resolveHooks</span></span><br></pre></td></tr></table></figure>

<p>这里 各种调用，也就意味着可能 不同步 吗? 反正这边是用 pending在 做 跳转前和跳转后的route一样保证</p>
<p>如果上面再成功则 回调<code>onComplete</code> 和 异步回调所有 <code>postEnterCbs</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">updateRoute (<span class="attr">route</span>: <span class="title class_">Route</span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>更新<code>this.current</code> 回调<code>this.cb</code>,调用所有<code>afterHooks</code></p>
<blockquote>
<p>其它自产自用函数</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">normalizeBase</span> (<span class="attr">base</span>: ?string): string &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;&#x2F; 这里是不是漏处理了<code>file://</code>开头的 对应之前有个bugfix类型</p>
<p>传了base值就前面加个&#x2F;，否则有<code>&lt;base&gt;</code> tag就取 其中base的部分，否则就空</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">resolveQueue</span> (</span><br><span class="line">  <span class="attr">current</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span><br><span class="line">  <span class="attr">next</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecord</span>&gt;</span><br><span class="line">): &#123;</span><br><span class="line">  <span class="attr">updated</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span><br><span class="line">  <span class="attr">activated</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span><br><span class="line">  <span class="attr">deactivated</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecord</span>&gt;</span><br><span class="line">&#125; &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>找第一个current和next中不一样的，下标idx,返回 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">updated</span>: next.<span class="title function_">slice</span>(<span class="number">0</span>, idx),</span><br><span class="line">  <span class="attr">activated</span>: next.<span class="title function_">slice</span>(idx),</span><br><span class="line">  <span class="attr">deactivated</span>: current.<span class="title function_">slice</span>(idx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">extractGuards</span> (</span><br><span class="line">  <span class="attr">records</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span><br><span class="line">  <span class="attr">name</span>: string,</span><br><span class="line">  <span class="attr">bind</span>: <span class="title class_">Function</span>,</span><br><span class="line">  reverse?: boolean <span class="comment">// 控制是返回的数组的顺序</span></span><br><span class="line">): <span class="title class_">Array</span>&lt;?<span class="title class_">Function</span>&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">extractGuard</span> (</span><br><span class="line">  <span class="attr">def</span>: <span class="title class_">Object</span> | <span class="title class_">Function</span>,</span><br><span class="line">  <span class="attr">key</span>: string</span><br><span class="line">): <span class="title class_">NavigationGuard</span> | <span class="title class_">Array</span>&lt;<span class="title class_">NavigationGuard</span>&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>把records中所有 <code>_Vue.extend(具体元素).options[name]</code>处理，如果是数组 对每一个 bind，如果非数组单个bind,最后<code>flatten</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">extractLeaveGuards</span> (<span class="attr">deactivated</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecord</span>&gt;): <span class="title class_">Array</span>&lt;?<span class="title class_">Function</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">extractGuards</span>(deactivated, <span class="string">&#x27;beforeRouteLeave&#x27;</span>, bindGuard, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">extractUpdateHooks</span> (<span class="attr">updated</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecord</span>&gt;): <span class="title class_">Array</span>&lt;?<span class="title class_">Function</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">extractGuards</span>(updated, <span class="string">&#x27;beforeRouteUpdate&#x27;</span>, bindGuard)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bindGuard</span> (<span class="attr">guard</span>: <span class="title class_">NavigationGuard</span>, <span class="attr">instance</span>: ?_Vue): ?<span class="title class_">NavigationGuard</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (instance) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">boundRouteGuard</span> () &#123;</span><br><span class="line">      <span class="keyword">return</span> guard.<span class="title function_">apply</span>(instance, <span class="variable language_">arguments</span>) <span class="comment">// 这里把参数`带`过去</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">extractEnterGuards</span> (</span><br><span class="line"><span class="comment">//  和上面同理绑定的是 &#x27;beforeRouteEnter&#x27; 和 &#x27;bindEnterGuard&#x27;</span></span><br><span class="line">) </span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">bindEnterGuard</span> (</span><br><span class="line">  <span class="attr">guard</span>: <span class="title class_">NavigationGuard</span>,</span><br><span class="line">  <span class="attr">match</span>: <span class="title class_">RouteRecord</span>,</span><br><span class="line">  <span class="attr">key</span>: string,</span><br><span class="line">  <span class="attr">cbs</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Function</span>&gt;,</span><br><span class="line">  <span class="attr">isValid</span>: <span class="function">() =&gt;</span> boolean</span><br><span class="line">): <span class="title class_">NavigationGuard</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>增加回调调用poll</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">poll</span> (</span><br><span class="line">  <span class="attr">cb</span>: any, <span class="comment">// somehow flow cannot infer this is a function</span></span><br><span class="line">  <span class="attr">instances</span>: <span class="title class_">Object</span>,</span><br><span class="line">  <span class="attr">key</span>: string,</span><br><span class="line">  <span class="attr">isValid</span>: <span class="function">() =&gt;</span> boolean</span><br><span class="line">) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><code>instances[key]._isBeingDestroyed</code>为false时 调用<code>cb(instances[key])</code> </p>
<p>这里 用<code>isValid()</code>也就是上面传入的<code>this.current === route</code>+ <code>setTimeout(16ms)</code>来判断要不要调用 poll</p>
<p>这是为了页面跳转了 但是 instances没有实例化完成 所以不停异步尝试?</p>
<h3 id="errors-js"><a href="#errors-js" class="headerlink" title="errors.js"></a>errors.js</h3><p>一个错误类 NavigationDuplicated</p>
<p><code>//support IE9</code> emmm</p>
<h3 id="hash-js"><a href="#hash-js" class="headerlink" title="hash.js"></a>hash.js</h3><p>和 html5,index 一样 都是继承于上面的 History</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// check history fallback deeplinking</span></span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getHash</span> (): string &#123;</span><br><span class="line">  <span class="comment">// We can&#x27;t use window.location.hash here because it&#x27;s not</span></span><br><span class="line">  <span class="comment">// consistent across browsers - Firefox will pre-decode it!</span></span><br><span class="line">  <span class="keyword">let</span> href = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span></span><br><span class="line">  <span class="keyword">const</span> index = href.<span class="title function_">indexOf</span>(<span class="string">&#x27;#&#x27;</span>)</span><br><span class="line">  <span class="comment">// empty path</span></span><br><span class="line">  <span class="keyword">if</span> (index &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  href = href.<span class="title function_">slice</span>(index + <span class="number">1</span>)</span><br><span class="line">  <span class="comment">// decode the hash but not the search or hash</span></span><br><span class="line">  <span class="comment">// as search(query) is already decoded</span></span><br><span class="line">  <span class="comment">// https://github.com/vuejs/vue-router/issues/2708</span></span><br><span class="line">  <span class="keyword">const</span> searchIndex = href.<span class="title function_">indexOf</span>(<span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> (searchIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> hashIndex = href.<span class="title function_">indexOf</span>(<span class="string">&#x27;#&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (hashIndex &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      href = <span class="built_in">decodeURI</span>(href.<span class="title function_">slice</span>(<span class="number">0</span>, hashIndex)) + href.<span class="title function_">slice</span>(hashIndex)</span><br><span class="line">    &#125; <span class="keyword">else</span> href = <span class="built_in">decodeURI</span>(href)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (searchIndex &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">      href = <span class="built_in">decodeURI</span>(href.<span class="title function_">slice</span>(<span class="number">0</span>, searchIndex)) + href.<span class="title function_">slice</span>(searchIndex)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> href</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>setupListeners()</code>调用 <code>setupScroll()</code></p>
<p>监听<code>popstate</code>或者<code>hashchange</code> 触发 <code>transitionTo()</code></p>
<p>push和replace也都是 调用 <code>transitionTo()</code> 回调的时候 <code>push/replace Hash()</code>然然后handleScroll, 和onComplete(route)</p>
<h3 id="html5-js"><a href="#html5-js" class="headerlink" title="html5.js"></a>html5.js</h3><p>和 hash不同的是， 在<code>constructor</code>里直接 初始化了 ，比如<code>setupScroll()</code>和 增加<code>popstate</code>事件触发,而不是让index.js调用</p>
<p>在 这里默认 pushState和replaceState都是可以用的</p>
<p>这里我在想 因为兼容而写的代码 值得吗，留多久，多久抛弃呢？</p>
<h2 id="index-js"><a href="#index-js" class="headerlink" title="index.js"></a>index.js</h2><p>import引入,不用细看，总之是引入依赖的</p>
<blockquote>
<p>VueRouter类实现</p>
</blockquote>
<p>想说 这种</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="attr">install</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="attr">version</span>: <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line"><span class="attr">app</span>: <span class="built_in">any</span>;</span><br><span class="line"><span class="attr">apps</span>: <span class="title class_">Array</span>&lt;<span class="built_in">any</span>&gt;;</span><br><span class="line"><span class="attr">ready</span>: <span class="built_in">boolean</span>;</span><br><span class="line"><span class="attr">readyCbs</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Function</span>&gt;;</span><br><span class="line"><span class="attr">options</span>: <span class="title class_">RouterOptions</span>;</span><br><span class="line"><span class="attr">mode</span>: <span class="built_in">string</span>;</span><br><span class="line"><span class="attr">history</span>: <span class="title class_">HashHistory</span> | <span class="title class_">HTML5History</span> | <span class="title class_">AbstractHistory</span>;</span><br><span class="line"><span class="attr">matcher</span>: <span class="title class_">Matcher</span>;</span><br><span class="line"><span class="attr">fallback</span>: <span class="built_in">boolean</span>;</span><br><span class="line"><span class="attr">beforeHooks</span>: <span class="title class_">Array</span>&lt;?<span class="title class_">NavigationGuard</span>&gt;;</span><br><span class="line"><span class="attr">resolveHooks</span>: <span class="title class_">Array</span>&lt;?<span class="title class_">NavigationGuard</span>&gt;;</span><br><span class="line"><span class="attr">afterHooks</span>: <span class="title class_">Array</span>&lt;?<span class="title class_">AfterNavigationHook</span>&gt;;</span><br></pre></td></tr></table></figure>

<p>写法对阅读来说真香，这是flow还是ts 来着</p>
<ul>
<li>this.matcher &#x3D; createMatcher(options.routes || [], this) &#x2F;&#x2F; 用户传入的routes</li>
</ul>
<p>三种 mode</p>
<p>‘hash’(默认 只识别井号后面的路径前面的忽略? window.location.hash),’history’,’abstract’(服务端node)</p>
<p>分别调用</p>
<ul>
<li>this.history &#x3D; new HTML5History(this, options.base)</li>
<li>this.history &#x3D; new HashHistory(this, options.base, this.fallback)</li>
<li>this.history &#x3D; new AbstractHistory(this, options.base)</li>
</ul>
<p>实例对外提供的方法 整理如下 </p>
<ul>
<li><p>match ( raw: RawLocation, current?: Route, redirectedFrom?: Location): Route<br> 转发了一下&#96;this.matcher.match(…)</p>
</li>
<li><p>get currentRoute (): ?Route 取的<code>this.history.current</code>的内容</p>
</li>
<li><p>init (app: any &#x2F;* Vue component instance *&#x2F;) TODO 暂时不知道这个怎么用</p>
</li>
<li><p>beforeEach (fn: Function): Function</p>
</li>
<li><p>beforeResolve (fn: Function): Function</p>
</li>
<li><p>afterEach (fn: Function): Function<br>这三个 都是i把函数注册通过registerHook注册到对应的XXXHooks数组中,返回的是从数组中移除他们的函数 </p>
</li>
<li><p>onReady (cb: Function, errorCb?: Function)</p>
</li>
<li><p>onError (errorCb: Function)<br> 转发了<code>this.history</code>上对应的方法</p>
</li>
<li><p>push (location: RawLocation, onComplete?: Function, onAbort?: Function)</p>
</li>
<li><p>replace (location: RawLocation, onComplete?: Function, onAbort?: Function)<br> !onComplete 且 !onAbort 且 Promise可用时，返回promise,否则同步执行，都是调用<code>this.history.push/replace(...)</code></p>
</li>
<li><p>go (n: number)</p>
</li>
<li><p>back ()</p>
</li>
<li><p>forward ()<br> 对<code>this.history.go(数值)</code>的转发</p>
</li>
<li><p>getMatchedComponents (to?: RawLocation | Route): Array<any><br> 通过对to解析成一个Route,获取其matched中的所有components</p>
</li>
<li><p>resolve (to: RawLocation,current?: Route,append?: boolean): { location: Location, route: Route, href: string, normalizedTo: Location, resolved: Route }<br> 这里 实际只有三个返回， 其中 location和normalizedTo一样,resolved 和route一样， 多最后两个 只是为了 向后兼容</p>
</li>
<li><p>addRoutes (routes: Array<RouteConfig>)</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">matcher</span>.<span class="title function_">addRoutes</span>(routes)</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">history</span>.<span class="property">current</span> !== <span class="variable constant_">START</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">history</span>.<span class="title function_">transitionTo</span>(<span class="variable language_">this</span>.<span class="property">history</span>.<span class="title function_">getCurrentLocation</span>())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是两个工具函数</p>
<p>registerHook(list,fn),  注册一个函数fn到list, 返回它的移除函数,概念就是以c++角度看作函数指针可以搜，同时问题就是， 没有防止重复，也就是同一个函数可以 加到list两次，而移除 每次只会移除一个，所以整体还是基于函数指针，并没有完全的实现 返回移除自己的函数。不过只要正确调用就不会出问题</p>
<p>和</p>
<p>createHref 完整路径拼接</p>
<p>最后是 向Vue里注入的 window.Vue.use(VueRouter)</p>
<h2 id="install-js"><a href="#install-js" class="headerlink" title="install.js"></a>install.js</h2><p>防重install</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">beforeCreate</span>(<span class="params"></span>)&#123;</span><br><span class="line">  注入和调用 <span class="title function_">registerInstance</span>(<span class="variable language_">this</span>,<span class="variable language_">this</span>)</span><br><span class="line">  延伸到vm.<span class="property">$options</span>.<span class="property">_parentVnode</span>.<span class="property">data</span>.<span class="title function_">registerRouteInstance</span>(<span class="variable language_">this</span>,<span class="variable language_">this</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mixin 渲染顺序  vue的组件 前序深搜, 子组件从父组件拿</p>
<p>属性定义 <code>$router</code>(实例),<code>$route</code>(当前状态),并且通过<code>Vue.util.defineReactive(this, &#39;_route&#39;, this._router.history.current)</code> 来保证改变时相应式触发</p>
<p>component定义 <code>RouterView</code>和<code>RouterLink</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> strats = <span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">optionMergeStrategies</span></span><br><span class="line"><span class="comment">// use the same hook merging strategy for route hooks</span></span><br><span class="line">strats.<span class="property">beforeRouteEnter</span> = strats.<span class="property">beforeRouteLeave</span> = strats.<span class="property">beforeRouteUpdate</span> = strats.<span class="property">created</span></span><br></pre></td></tr></table></figure>

<h2 id="util"><a href="#util" class="headerlink" title="util"></a>util</h2><p>这一块的使用可以看<code>test/unit/specs</code>里的用例</p>
<h3 id="async-js"><a href="#async-js" class="headerlink" title="async.js"></a>async.js</h3><p><code>export function runQueue (queue: Array&lt;?NavigationGuard&gt;, fn: Function, cb: Function) &#123;</code></p>
<p>对数组中逐个调用 函数<code>fn(queue[index],回调)</code>,在上一个回调后调用下一个函数,最后触发<code>cb()</code> </p>
<p>用的 自定义<code>step</code>箭头函数 依次<code>step(index)</code></p>
<h3 id="dom-js"><a href="#dom-js" class="headerlink" title="dom.js"></a>dom.js</h3><p><code>export const inBrowser = typeof window !== &#39;undefined&#39;</code></p>
<h3 id="location-js"><a href="#location-js" class="headerlink" title="location.js"></a>location.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">normalizeLocation</span> (</span><br><span class="line">  <span class="attr">raw</span>: <span class="title class_">RawLocation</span>,</span><br><span class="line">  <span class="attr">current</span>: ?<span class="title class_">Route</span>,</span><br><span class="line">  <span class="attr">append</span>: ?boolean,</span><br><span class="line">  <span class="attr">router</span>: ?<span class="title class_">VueRouter</span></span><br><span class="line">): <span class="title class_">Location</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><code>_normalized</code>来标记处理过</p>
<p>其它字段 <code>path</code>,<code>query:resolveQuery(...)</code>,<code>hash</code>,<code>name</code>,<code>params</code></p>
<h3 id="misc-js"><a href="#misc-js" class="headerlink" title="misc.js"></a>misc.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">extend</span> (a, b) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> b) &#123;</span><br><span class="line">    a[key] = b[key]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="params-js"><a href="#params-js" class="headerlink" title="params.js"></a>params.js</h3><p>用<code>regexpCompileCache</code> 缓存 编译后的正则</p>
<p>使用<code>path-to-regexp</code>来完成 路径正则匹配</p>
<p><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/path-to-regexp">https://www.npmjs.com/package/path-to-regexp</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">fillParams</span> (</span><br><span class="line">  <span class="attr">path</span>: string,</span><br><span class="line">  <span class="attr">params</span>: ?<span class="title class_">Object</span>,</span><br><span class="line">  <span class="attr">routeMsg</span>: string</span><br><span class="line">): string &#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="path-js"><a href="#path-js" class="headerlink" title="path.js"></a>path.js</h3><p>比如这个文件感觉 看测试 比看代码更能理解函数功能</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">resolvePath</span> (</span><br><span class="line">  <span class="attr">relative</span>: string,</span><br><span class="line">  <span class="attr">base</span>: string,</span><br><span class="line">  append?: boolean</span><br><span class="line">): string &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>路径解析咯 甚至还”解析”了 <code>.</code>和<code>..</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parsePath</span> (<span class="attr">path</span>: string): &#123;</span><br><span class="line">  <span class="attr">path</span>: string; <span class="comment">// 去掉 query和 hash的部分</span></span><br><span class="line">  <span class="attr">query</span>: string; <span class="comment">// 问号以后  </span></span><br><span class="line">  <span class="attr">hash</span>: string; <span class="comment">// 井号及以后</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>cleanPath(path: string):string ,把路径里的连续两个斜杠变为一个斜杠</p>
<h3 id="push-state-js"><a href="#push-state-js" class="headerlink" title="push-state.js"></a>push-state.js</h3><ul>
<li>常量布尔 supportsPushState, 可以从这个源代码 看到特殊判断不支持的ua,剩余的 通过window.history是否有 pushState方法进行判断</li>
<li>function pushState (url?: string, replace?: boolean) { 依赖于 <code>window.history  .pushState/replaceState</code>这俩个那个方法，通过replace参数决定调用哪个,如果挂掉(..) 则改为调用<code>window.location.replace/assign(url)</code>的方法</li>
<li>function replaceState (url?: string) { 调用封装的pushState</li>
</ul>
<p>这里可能挂掉的注释是</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// try...catch the pushState call to get around Safari</span></span><br><span class="line"><span class="comment">// DOM Exception 18 where it limits to 100 pushState calls</span></span><br></pre></td></tr></table></figure>

<h3 id="query-js"><a href="#query-js" class="headerlink" title="query.js"></a>query.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">resolveQuery</span> (</span><br><span class="line">  <span class="attr">query</span>: ?string,</span><br><span class="line">  <span class="attr">extraQuery</span>: <span class="title class_">Dictionary</span>&lt;string&gt; = &#123;&#125;,</span><br><span class="line">  <span class="attr">_parseQuery</span>: ?<span class="title class_">Function</span></span><br><span class="line">): <span class="title class_">Dictionary</span>&lt;string&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>基本就是,把url里的请求参数query 和 字典里的extraQuery，转化为 Dictionary<string></p>
<p>如果有相同的让extraQuery覆盖query里的 这里明明是可以用<code>misc.js</code>的<code>extend</code> 为何没用&#x3D;。&#x3D; 是有什么考虑么</p>
<p>然后默认内部实现了如上所述的parseQuery函数，你也可以自己实现一个传进去，从测试样例上看，是没有测这个<code>_parseQuery</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">stringifyQuery</span> (<span class="attr">obj</span>: <span class="title class_">Dictionary</span>&lt;string&gt;): string &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>转化为url上的请求参数格式 记得encode</p>
<p>此外就是上面 使用了一些 url的编码解码 函数</p>
<h3 id="resolve-components-js"><a href="#resolve-components-js" class="headerlink" title="resolve-components.js"></a>resolve-components.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">flatMapComponents</span> (</span><br><span class="line">  <span class="attr">matched</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecord</span>&gt;,</span><br><span class="line">  <span class="attr">fn</span>: <span class="title class_">Function</span></span><br><span class="line">): <span class="title class_">Array</span>&lt;?<span class="title class_">Function</span>&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>对matched的每个元素<code>m</code>,中<code>m.components</code>的每个<code>key</code> 调用<code>fn(m.components[key],m.instances[key],m,key)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">resolveAsyncComponents</span> (<span class="attr">matched</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecord</span>&gt;): <span class="title class_">Function</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>返回一个闭包函数 <code>(to,from,next)=&gt;&#123;&#125;</code></p>
<p>使用了上面的<code>flatMapComponents</code></p>
<p>通过内部 两个变量<code>hasAsync</code>和<code>pending</code>来控制 next()</p>
<p>这里没有使用<code>to</code>和<code>from</code>只有 <code>next()</code>和<code>matched</code> </p>
<p>没有很懂的是 这里<code>def = matched某个 的components[key]</code>,就是其某个<code>_Vue.extend()</code></p>
<p>但是这里<code>resolve,reject</code>都是<code>once</code></p>
<p>下面为什么 既有<code>res = def(resolve,reject)</code>又有 <code>res.then(resolve, reject)</code></p>
<p>emmmmmmmmm所以这里正向功能 是配置所有 <code>components[key]</code> 之后调用 <code>next()</code>?</p>
<p>然后似乎为了兼容不同语法，写了比较神奇的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">flatten</span> (<span class="attr">arr</span>: <span class="title class_">Array</span>&lt;any&gt;): <span class="title class_">Array</span>&lt;any&gt; &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>emmm名为flatten，实际 只是 <code>Array.prototype.concat.apply([],arr)</code>,所以最多flatten一层</p>
<p>比如<code>[1,[2,[3,[4]]]] -&gt; [1,2,[3,[4]]]</code></p>
<h3 id="route-js"><a href="#route-js" class="headerlink" title="route.js"></a>route.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createRoute</span> (</span><br><span class="line">  <span class="attr">record</span>: ?<span class="title class_">RouteRecord</span>,</span><br><span class="line">  <span class="attr">location</span>: <span class="title class_">Location</span>,</span><br><span class="line">  redirectedFrom?: ?<span class="title class_">Location</span>,</span><br><span class="line">  router?: <span class="title class_">VueRouter</span></span><br><span class="line">): <span class="title class_">Route</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>返回的是一个<code>Object.freeze(Route)</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// the starting route that represents the initial state</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="variable constant_">START</span> = <span class="title function_">createRoute</span>(<span class="literal">null</span>, &#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isSameRoute</span> (<span class="attr">a</span>: <span class="title class_">Route</span>, <span class="attr">b</span>: ?<span class="title class_">Route</span>): boolean &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>b=== START</code>,那么 <code>return a===START</code> 所以不会再生成<code>START</code>?</p>
<p>对 a和b的path,name,hash,query,params 这些 需要比较的进行深比较</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isIncludedRoute</span> (<span class="attr">current</span>: <span class="title class_">Route</span>, <span class="attr">target</span>: <span class="title class_">Route</span>): boolean &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>目标path是当前path的前缀，目标hash为空或者和当前hash相等，目标query的key在当前key中都出现过 &#x3D;.&#x3D;这个规则 好迷啊</p>
<p>这里 有单独实现<code>clone</code>和<code>isObjectEqual</code>两个方法，都实现了深度处理，但是没有实现可能出现的循环引用。不过因为都是 Route中的 “可控制的”参数,认为是不会出现循环引用的。</p>
<h3 id="scroll-js"><a href="#scroll-js" class="headerlink" title="scroll.js"></a>scroll.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setupScroll</span> () &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>看得出自闭的感受了 这里三个注释 <code>Fix #balabala</code></p>
<p><code>监听popstate =&gt;  export function saveScrollPosition () &#123; positionStore[当前 状态key] = 保存x,y偏移</code> </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">handleScroll</span> (</span><br><span class="line">  <span class="attr">router</span>: <span class="title class_">Router</span>,</span><br><span class="line">  <span class="attr">to</span>: <span class="title class_">Route</span>,</span><br><span class="line">  <span class="attr">from</span>: <span class="title class_">Route</span>,</span><br><span class="line">  <span class="attr">isPop</span>: boolean</span><br><span class="line">) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;&#x2F; wait until re-render finishes before scrolling</p>
<p><code>router.app.$nextTick()</code>里执行 调用<code>router.options.scrollBehavior.call(router,to,from,isPop?position:null)</code> 来判断是否需要滚动，如果需要<br> 则调用 <code>scrollToPosition(...)</code></p>
<h3 id="state-key-js"><a href="#state-key-js" class="headerlink" title="state-key.js"></a>state-key.js</h3><p>上面文件会用到 <code>gen/get/set StateKey</code>,然后 值是直接取用的 <code>Time.now().toFixed(3)</code></p>
<p>至于<code>Time</code> 可能取 <code>window.performance</code>或者<code>Date</code></p>
<h3 id="warn-js"><a href="#warn-js" class="headerlink" title="warn.js"></a>warn.js</h3><p><code>assert/warn/isError/isExtendedError</code></p>
<p>如果grep代码 发现 都是说 <code>process.env.NODE_ENV !== &#39;production&#39;</code></p>
<p>那么问题来了 为什么 不写成 只在 函数内,外部直接调用</p>
<p>或者说</p>
<p>为什么不写成，传递参数增加一个env?</p>
<p>再或者</p>
<p>详细命名出一个函数 warnNonPro</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>Onhashchange 的触发来源</p>
<ul>
<li>修改浏览器地址 增加改变#hash</li>
<li>修改location.href &#x2F; location.hash</li>
<li>点击锚点链接</li>
<li>浏览器前进后退变化</li>
</ul>
<p>hash</p>
<p>routeLink负责</p>
<ul>
<li>阻止默认行为 如click e.preventDefault()</li>
<li>设置 location.hash</li>
</ul>
<p>routeView负责</p>
<ul>
<li>window.addEventListener(‘hashchange’,e&#x3D;&gt;{具体工作 比如页面渲染});</li>
</ul>
<p>history(用的h5 api)</p>
<p>pushState 不触发页面刷新，只改变history对象，是同源策略保护限制的</p>
<p>popstate 页面组件刷新</p>
<p>routeLink负责</p>
<ul>
<li>阻止默认行为 如click e.preventDefault()</li>
<li>polyfill补丁，支持低版本浏览器。新版本的才有history.pushState()</li>
<li>window.history.pushState(对象,link,link);<br>routeView负责</li>
<li>window.addEventListener(‘popstate’,e&#x3D;&gt;{具体工作 比如页面渲染}); 由浏览器前进后退按钮 触发,或者history方法触发</li>
</ul>
<p>不支持pushState会降级到hash模式</p>
<h1 id="examples"><a href="#examples" class="headerlink" title="examples"></a>examples</h1><blockquote>
<p>对照 源码里的 example再来回顾实现</p>
</blockquote>
<p>在源码的<code>examples/</code>文件夹里</p>
<p>通过<code>npm run dev</code>来启动</p>
<h2 id="basic"><a href="#basic" class="headerlink" title="basic"></a>basic</h2><pre><code>mode: &#39;history&#39;,
base: __dirname,
</code></pre>
<p><code>grep -r &quot;base&quot; src/</code> 可以回顾一下 base相关的实现</p>
<pre><code>    &lt;router-link tag=&quot;li&quot; to=&quot;/bar&quot; :event=&quot;[&#39;mousedown&#39;, &#39;touchstart&#39;]&quot;&gt;
      &lt;a&gt;/bar&lt;/a&gt;
    &lt;/router-link&gt;
    
</code></pre>
<p>这一部分 回顾 link的实现 , tag不为a 则会 递归在this.$slots.default找第一个a元素,然后 绑上事件, 然后 event 是对应 在找到的标签a上的所有 on事件改为 阻止默认事件 调用<br><code>router.push/replace</code>,</p>
<p>所以这个<code>/bar</code>鼠标点击下 就会触发， 页面上另一个<code>/bar</code> 要释放才会触发</p>
<p>那么，跟觉源码的逻辑 这样 做后会触发两次 push ,两次 transitionTo，两次 confirmTransition，然后 通过 base.js中的isSameRoute中判读是否是同一个Route,如果是 则调用ensureURL,最后调用 abort,</p>
<p>而 abort中 如果是 NavigationDuplicated的 错误 则不会 warn,会调用 回调函数(如果传递了),</p>
<p>当然 如果你已经在一个路径下 那么你点击 一个指向当前的路由 也会 走上面的逻辑(不是两次),在<code>isSameRoute</code>后就不会再走动</p>
<p>其中的<code>to</code> 是通过<code>router.resolve(this.to,current,this.append)</code>解析出的目标地址</p>
<pre><code>navigateAndIncrement () &#123;
</code></pre>
<p>实现了直接去调用<code>$router.push</code>方法 ,你可以通过浏览器的返回看到push的效果</p>
<pre><code>    &lt;router-link to=&quot;/foo&quot; v-slot=&quot;props&quot;&gt;
      &lt;li :class=&quot;[props.isActive &amp;&amp; &#39;active&#39;, props.isExactActive &amp;&amp; &#39;exact-active&#39;]&quot;&gt;
        &lt;a :href=&quot;props.href&quot; @click=&quot;props.navigate&quot;&gt;&#123;&#123; props.route.path &#125;&#125; (with v-slot).&lt;/a&gt;
      &lt;/li&gt;
    &lt;/router-link&gt;
</code></pre>
<p>这一段 会对应link中的 scopedSlot, 注意到 它并没有 传递<code>activeClass</code> 和 <code>exactActiveClass</code>而是 自己组件里 动态计算class,然后这里 </p>
<p>这里也是把 源码中传递的所有参数都用到了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">$scopedSlots</span>.<span class="title function_">default</span>(&#123;</span><br><span class="line">  href,</span><br><span class="line">  route,</span><br><span class="line">  <span class="attr">navigate</span>: handler,</span><br><span class="line">  <span class="attr">isActive</span>: classes[activeClass],</span><br><span class="line">  <span class="attr">isExactActive</span>: classes[exactActiveClass]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>html最下面 </p>
<pre><code>  &lt;pre id=&quot;query-t&quot;&gt;&#123;&#123; $route.query.t &#125;&#125;&lt;/pre&gt;
  &lt;pre id=&quot;hash&quot;&gt;&#123;&#123; $route.hash &#125;&#125;&lt;/pre&gt;
</code></pre>
<p>都是 过程中计算出来的当前 Route上的参数 query</p>
<p>同时可以发现 当 路由改变时 所有 RouterLink 的render函数 都被重新调用</p>
<h2 id="hash-mode"><a href="#hash-mode" class="headerlink" title="hash-mode"></a>hash-mode</h2><p>和basic vimdiff一下 </p>
<p>首先 最主要的变化是 <code>mode:&#39;hash&#39;</code></p>
<p>此外这里加入了 <code>/xxx/:yyy</code>这样的匹配</p>
<p>然后在<code>router-link</code>部分 就只使用了最基本的写法</p>
<p>mode也就是 直接文件<code>history/hash.js</code></p>
<p>然后 冒号路径 同样是 <code>link.js</code>中render里的 router.resolve, 源码反过去搜的话是 <code>index.js: resolve(to...) -&gt;  location.js: normalizeLocation(raw...), -&gt; index.js:match(raw...) -&gt; create-matcher.js:match </code></p>
<p>这里 有点问题! 虽然说<code>index.js::match</code> 和 <code>create-matcher.js</code>里都是有返回Route的,但是，在 match的一些情况下 传入的raw被更改了 比如加上了params，因为 在 normalizeLocation里 返回的location &#x3D;&#x3D; raw,就有了 后面 match中修改改location时修改了 raw,</p>
<p>也就是 说 在link中 这个返回的location可能是带上 params 也可能没有，所以这是不可靠的&#x3D;.&#x3D;</p>
<p>每当这时 就会怀念 c++中的 const引用参数 </p>
<p>然后 当点击时 是触发<code>hash.js::push -&gt; bash.js::transitionTo -&gt; router.match 匹配出Route -&gt; base.js updateRoute 跟心 current = route</code></p>
<p>其中处理冒号格式的是靠 <code>src/util/params.js</code> 中使用’path-to-regexp’,在 match函数中使用 </p>
<p>这样也就是 把 计算出的params 之类的 丢到了<code>$route</code>上</p>
<h2 id="nested-routes"><a href="#nested-routes" class="headerlink" title="nested-routes"></a>nested-routes</h2><ol>
<li>是<code>route</code>表中 有 <code>name&#39;</code> 这样写to就可以 不用写详细路径</li>
</ol>
<p>实现就是靠 <code>create-matcher.js</code>的<code>nameMap</code>来实现<code>名字-&gt; url/:xxx/yy</code> 以及 对应的正则</p>
<p>emmmmm 经过调试 都在 createRouteMap中把 nameMap做好了,在 下面 <code>record=nameMap[name]</code>始终 都有值</p>
<p>路径也在<code>create-matcher.js</code>中的<code>locatoin.path = fillParams</code>合并</p>
<p>例如</p>
<p><code>fillParams(&#39;/parent/qux/:quxId/quux&#39;,&#123;quxId: &quot;1&quot;, zapId: 2&#125;)</code></p>
<p>我们可以尝试添加 <code>fillParams /parent/qux/:quxId/quux &#123;quxId: &quot;1&quot;, zapId: 2&#125;</code></p>
<p>你会发现 点击会跳转到根(如果没有 quxId) 会报warn <code>[vue-router] missing param for named route &quot;quux&quot;: Expected &quot;quxId&quot; to be defined</code></p>
<p>在url上是根但是 在 router-view上 还是 按照 name的层次渲染的</p>
<p>这里一个问题就是 说 name 不能重复 会报错 <code>[vue-router] Duplicate named routes definition: &#123; name: &quot;quuy&quot;, path: &quot;/parent/qux/:quxId/quuy&quot; &#125;</code> 但如果不管的话, name根据不重复建立 只会保存第一个</p>
<p>第二个就是说 即使从<code>xxx/:quxId</code> 直接跳 <code>name:&#39;quux&#39;</code>也是会回到主页, 因为虽然原来 quxId有值,但树形解析 上并没有quxId的值</p>
<ol start="2">
<li>是嵌套的 路由表 和 嵌套的 router-view</li>
</ol>
<p>路由表嵌套 上面1.已经说了，然后 router-view 嵌套 靠的就是上面 源码阅读中讲的 matched 的计算,见<a href="router-view.js">view.js</a></p>
<p>即每一层<code>router-view</code>渲染是通过depth 去<code>$route.matched[depth]</code>取值</p>
<h2 id="named-routes"><a href="#named-routes" class="headerlink" title="named-routes"></a>named-routes</h2><p>基本就是 router配置的时候 带name，然后 router-link 的to时 配置 name,也可以配置 params</p>
<p>没啥新的东西 </p>
<p>上面nested-routes都展示了</p>
<h2 id="named-view"><a href="#named-view" class="headerlink" title="named-view"></a>named-view</h2><p><code>router-view</code> 上加上了 name</p>
<p>路由里配置</p>
<pre><code>  components: &#123;
    default: Baz,
    a: Bar,
    b: Foo
  &#125;
</code></pre>
<p>那么在 取的时候 根据props的name 去<code>matched.components[name]</code>中获得</p>
<h1 id="和vue实例生命周期顺序"><a href="#和vue实例生命周期顺序" class="headerlink" title="和vue实例生命周期顺序"></a>和vue实例生命周期顺序</h1><p>打开<code>codesandbox.io</code> 把<code>main.js</code>替换为下面,记得引入<code>vue-router</code>依赖</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Vue</span> <span class="keyword">from</span> <span class="string">&quot;vue&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">VueRouter</span> <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span>;</span><br><span class="line"><span class="title class_">Vue</span>.<span class="property">config</span>.<span class="property">productionTip</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>.<span class="title function_">use</span>(<span class="title class_">VueRouter</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Foo</span> = &#123;</span><br><span class="line">  <span class="attr">template</span>:</span><br><span class="line">    <span class="string">&#x27;&lt;div&gt;&lt;h1&gt;foo&lt;/h1&gt;&lt;router-link to=&quot;/bar&quot;&gt;Go to Bar&lt;/router-link&gt;&lt;/div&gt;&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="title function_">beforeRouteEnter</span>(<span class="params">to, <span class="keyword">from</span>, next</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;foo inner beforeRouteEnter&quot;</span>);</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">beforeRouteUpdate</span>(<span class="params">to, <span class="keyword">from</span>, next</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;foo inner beforeRouteUpdate&quot;</span>);</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">beforeRouteLeave</span>(<span class="params">to, <span class="keyword">from</span>, next</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;foo inner beforeRouteLeave&quot;</span>);</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="title function_">beforeCreated</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;foo beforeCreated&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">created</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;foo created&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">beforeMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;foo beforeMount&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">mounted</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;foo mounted&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">beforeDestroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;foo beforeDestroy&quot;</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">destroyed</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;foo destroyed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Bar</span> = &#123;</span><br><span class="line">  <span class="attr">template</span>:</span><br><span class="line">    <span class="string">&#x27;&lt;div&gt;&lt;h1&gt;bar&lt;/h1&gt;&lt;router-link to=&quot;/foo&quot;&gt;Go to foo&lt;/router-link&gt;&lt;/div&gt;&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&quot;/foo&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Foo</span>,</span><br><span class="line">    <span class="attr">beforeEnter</span>: <span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Foo beforeEnter&quot;</span>);</span><br><span class="line">      <span class="title function_">next</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">path</span>: <span class="string">&quot;/bar&quot;</span>, <span class="attr">component</span>: <span class="title class_">Bar</span> &#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">VueRouter</span>(&#123;</span><br><span class="line">  routes</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">beforeEach</span>(<span class="function">(<span class="params">to, <span class="keyword">from</span>, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;global beforeEach&quot;</span>);</span><br><span class="line">  <span class="title function_">next</span>();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">afterEach</span>(<span class="function">(<span class="params">to, <span class="keyword">from</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;global afterEach&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">template</span>: <span class="string">&#x27;&lt;div id=&quot;app&quot;&gt;&lt;router-view /&gt;&lt;/div&gt;&#x27;</span>,</span><br><span class="line">  router</span><br><span class="line">&#125;).$mount(<span class="string">&quot;#app&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>查看<code>console</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">global beforeEach </span><br><span class="line">Foo beforeEnter </span><br><span class="line">foo inner beforeRouteEnter </span><br><span class="line">global afterEach </span><br><span class="line">foo created </span><br><span class="line">foo beforeMount </span><br><span class="line">foo mounted </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">foo inner beforeRouteLeave </span><br><span class="line">global beforeEach </span><br><span class="line">global afterEach </span><br><span class="line">foo beforeDestroy </span><br><span class="line">foo destroyed </span><br></pre></td></tr></table></figure>

<p>验证了我们上面阅读的源码，<code>router-view</code> 来管理了组件的渲染，虽然有的函数从代码视角写在组件内部，但实际上是<code>vuer-router</code>确定要渲染组件以后，才会调用<code>vue</code>提供的产生<code>VNode</code>的方法，因此，给<code>router</code>用的是由<code>router</code>来用，也就自然早于<code>vue</code>本身的生命周期了</p>
<h1 id="个人其它收获"><a href="#个人其它收获" class="headerlink" title="个人其它收获"></a>个人其它收获</h1><ol start="0">
<li>vuex,vue-router的example 都是 用express写的</li>
<li>vuex,vue-router的文档都是vuepress生成的</li>
<li>vuex的开发测试 目测没有flow，vue-router的测试有用到flow，两者似乎都用到了tsc</li>
<li>dev,测试,release 全部脚本化了</li>
<li>之前有不少地方建议用typeof &#x3D;&#x3D; ‘undefined’来比较undefined,这里源码写的依然是 !&#x3D;&#x3D; undefined来比较，感觉这些就算可有可无的建议吧(吗)</li>
<li>另外就是 之前有想过说 代码里尽量避免字符串 作为逻辑运算，用enum或者常量，或者常量意义的变量代替，这里看源码依然后很多case 字符串，或者字符串直接比较的。</li>
<li>又多了一点源码阅读经验，因为 很多源码现在都已经有自动测试了，所以在直接看 util &#x2F;helper之类的 代码时，先看对应的测试代码可以 快速知道这个代码是干啥用的，再阅读代码就会更容易理解</li>
<li>比如query里明明是可以用<code>misc.js</code>的<code>extend</code> 为何没用&#x3D;。&#x3D; 是有什么考虑么</li>
<li>Object.freeze，没有深入研究，但拉去属性可以看到writable都变成false</li>
<li>这里为了兼容多种语法，采用的是在具体的函数里接受+一堆if来处理，而不是提供单一标准参数让调用者控制参数。</li>
<li><code>this.$scopedSlots.default(&#123;</code>没有查到,但是 看源码中的ts 是 <code>$scopedSlots[slot名字]=(props:any)=&gt;ScopedSlotChildren;</code>)</li>
<li>看多了源码 你会发现很多<code>process.env.NODE_ENV !== &#39;production&#39;</code> 时会报warn,同时 也知道了如果你要负责构建打包，看似 一个字符串’production’其实是会参与逻辑</li>
<li><a target="_blank" rel="noopener" href="https://vuejs.org/v2/guide/render-function.html#Functional-Components">functional 组件</a> </li>
<li>里面实现的函数有一些潜在side-effect的 比如 match,可能会修改到raw,这种时候就会怀念C++的const引用</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/hashchange_event">hashchange 事件 mozilia文档</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/popstate_event">popstate</a></p>
<p><a target="_blank" rel="noopener" href="https://flow.org/en/docs/">flow</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base">base tag</a></p>
<h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><p>看一下 mixin文档了，不然有些方法看得不太理解</p>
<ul>
<li>install, beforeCreate, $options registerRouteInstance?,defineProperty</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://vuejs.org/v2/api/#optionMergeStrategies">https://vuejs.org/v2/api/#optionMergeStrategies</a></p>
<p>Vue.util.defineReactive(this, ‘_route’, this._router.history.current)</p>
<p>pwa</p>
<p>vue-ssr</p>
<p>ivew</p>
<p>单元测试</p>
<p>nuxtjs</p>
<p><a target="_blank" rel="noopener" href="https://npmdoc.github.io/node-npmdoc-vue/build..beta..travis-ci.org/apidoc.html#apidoc.element.vue.util.defineReactive">https://npmdoc.github.io/node-npmdoc-vue/build..beta..travis-ci.org/apidoc.html#apidoc.element.vue.util.defineReactive</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/Blog/page/6/"><i class="fa fa-angle-left" aria-label="上一頁"></i></a><a class="page-number" href="/Blog/">1</a><a class="page-number" href="/Blog/page/4/">4</a><a class="page-number" href="/Blog/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/Blog/page/8/">8</a><a class="page-number" href="/Blog/page/10/">10</a><a class="page-number" href="/Blog/page/13/">13</a><a class="extend next" rel="next" href="/Blog/page/8/"><i class="fa fa-angle-right" aria-label="下一頁"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cro-Marmot</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="總字數">684k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="所需總閱讀時間">10:22</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 強力驅動
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/Blog/js/comments.js"></script><script src="/Blog/js/utils.js"></script><script src="/Blog/js/schemes/muse.js"></script><script src="/Blog/js/next-boot.js"></script><script src="/Blog/js/bookmark.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/Blog/js/third-party/search/local-search.js"></script>





  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/Blog/js/third-party/math/mathjax.js"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.2.0/quicklink.umd.js" integrity="sha256-4kQf9z5ntdQrzsBC3YSHnEz02Z9C1UeW/E9OgnvlzSY=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":false,"home":false,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://cromarmot.github.io/Blog/page/7/"}</script>
  <script src="/Blog/js/third-party/quicklink.js"></script>
<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"cromarmot","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/Blog/js/third-party/comments/disqus.js"></script>

</body>
</html>
